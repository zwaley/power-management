# 端口拓扑图问题诊断报告

## 问题概述
用户反映端口拓扑图显示异常，包括：
1. 上半部分选择四层或五层时都显示上下分层图
2. 下半部分不同布局模式显示不正常
3. 怀疑存在两套代码运行导致的不一致问题

## 诊断过程

### 1. 代码执行入口分析
- **run.py**: 开发启动脚本，使用`uvicorn.run("main:app", reload=True)`
- **main.py**: 主应用文件，底部有生产环境启动代码`uvicorn.run(app, reload=False)`
- **问题**: 可能同时运行了两个实例导致代码不一致

### 2. 端口冲突排查
- 发现8009端口被PID 14588的python.exe占用
- 已强制终止该进程并重新启动到8009端口
- 统一配置文件，确保只有一套代码运行

### 3. 端口拓扑图API实现分析

#### 当前实现问题
1. **端口名称不符合规范**
   - 当前使用: `conn.source_fuse_number` 或 `conn.source_breaker_number`
   - 规范要求: 严格采用用户提交的原始`port_name`

2. **左右分区逻辑错误**
   - 当前实现: 简单按`port_count % 2`奇偶数分配
   - 规范要求: 按端口总数平均分配到左右两侧

3. **缺少箭头方向控制**
   - 当前实现: 固定箭头方向
   - 规范要求: 根据Connection表的"上下游"字段控制箭头方向

4. **连接线颜色不符合规范**
   - 当前实现: 固定红色`#ef4444`
   - 规范要求: 交流电缆黄色，直流电缆红色，空闲端口灰色虚线

5. **节点标签格式问题**
   - 当前实现: 简单显示端口名称
   - 规范要求: 设备节点显示"机房名称 + 设备名称"，端口节点显示原始port_name

### 4. 前后端数据格式不匹配
- 前端期望的vis.js格式与后端返回格式可能不一致
- 布局类型(LR/UD)参数传递可能有问题

## 修复方案

### 1. 重写端口拓扑图API
按照设计规范完全重写`/api/port-topology/{device_id}`实现：
- 使用原始port_name作为端口标识
- 实现正确的左右分区平衡算法
- 根据"上下游"字段控制箭头方向
- 实现正确的连接线颜色映射
- 优化节点标签格式

### 2. 修复前端布局参数传递
- 确保布局类型参数正确传递到API
- 验证vis.js数据格式兼容性

### 3. 测试验证
- 使用设备ID=13进行功能验证
- 测试不同布局模式的切换
- 验证箭头方向和连接线颜色

## 风险评估
- **高风险**: API重写可能影响现有功能
- **中风险**: 数据格式变更可能导致前端显示异常
- **低风险**: 配置统一不会影响核心功能

## 回退方案
- 保留当前API实现的备份
- 如果新实现有问题，可以快速回退到当前版本
- 分步骤实施，每个步骤都可以独立回退

## 下一步行动
1. 备份当前实现
2. 按设计规范重写API
3. 测试验证功能
4. 更新文档记录