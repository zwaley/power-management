错误与经验记录（持续更新）

记录原则
- 重要错误与异常必须记录：错误现象、原因分析、定位过程、修复方案、验证结果、回退预案。
- 重要操作与经验必须记录：要点、注意事项、通用解决路径，避免重复犯错与重复劳动。

2025-09-29 WinError 10013 导致开发服务器启动失败
- 现象：运行 python run.py 后，报错 [WinError 10013] 以一种访问权限不允许的方式做了一个访问套接字的尝试。
- 初步判断：
  1) 端口被占用；或
  2) Windows 防火墙拦截 0.0.0.0 监听方式。
- 定位过程：
  1) 使用 netstat -ano | findstr :8009 检测端口占用，发现 PID=14588 的 python.exe 正在监听 8009；
  2) 使用 tasklist /FI "PID eq 14588" 确认占用进程为 Python；
  3) 结合日志，确定为端口冲突导致启动失败。
- 修复方案：
  1) 将默认端口从 8009 改为 18009；
  2) 将绑定地址从 0.0.0.0 改为 127.0.0.1（本地回环），降低防火墙拦截概率。
- 具体改动：
  - config.py：新增 HOST=127.0.0.1，PORT 默认改为 18009；
  - run.py：uvicorn.run 使用 HOST 与 PORT；启动提示打印 http://127.0.0.1:18009；
  - main.py：引入 HOST 变量（备用），保留统一配置使用。
- 验证结果：
  - 成功启动：Uvicorn running on http://127.0.0.1:18009；
  - 预览 /graph 页面：浏览器控制台无错误；页面元素与交互正常。
- 回退预案：
  - 若需要恢复到旧端口，修改 config.py 的 PORT 为 8009；
  - 若需要对外访问，HOST 改为 0.0.0.0（需评估防火墙策略与安全影响）。

2025-09-29 端口拓扑图显示异常问题
- 现象：用户反映端口拓扑图显示不正常，上半部分选择四层或五层时都显示上下分层图，下半部分不同布局模式显示异常。
- 初步判断：
  1) 可能存在两套代码运行导致不一致；
  2) 端口拓扑图API实现不符合设计规范；
  3) 前后端数据格式不匹配。
- 定位过程：
  1) 发现8009端口被占用，强制终止进程并统一配置；
  2) 分析端口拓扑图API实现，发现多个不符合设计规范的问题；
  3) 对照设计规范文档，确认具体偏差。
- 发现的问题：
  1) 端口名称使用 fuse_number/breaker_number 而非原始 port_name；
  2) 左右分区逻辑错误，简单按奇偶数分配而非平均分配；
  3) 缺少箭头方向控制，未根据"上下游"字段设置；
  4) 连接线颜色固定红色，未按交流/直流区分；
  5) 节点标签格式不符合规范。
- 修复方案：
  1) 统一代码执行入口，确保只有一套代码运行；
  2) 按设计规范完全重写端口拓扑图API；
  3) 实现正确的左右分区平衡算法；
  4) 根据"上下游"字段控制箭头方向；
  5) 实现正确的连接线颜色映射（交流黄色，直流红色，空闲灰色）；
  6) 优化节点标签格式（设备节点显示机房+设备名，端口节点显示原始port_name）。
- 具体改动：
  - 恢复config.py到8009端口和0.0.0.0绑定；
  - 完全重写/api/port-topology/{device_id}实现；
  - 使用原始source_port/target_port作为端口标识；
  - 实现平均分配的左右分区算法；
  - 根据upstream_downstream字段控制箭头方向；
  - 根据connection_type设置连接线颜色。
- 验证结果：
  - 服务器成功启动在8009端口；
  - /graph页面可正常访问；
  - 待进一步测试设备ID=13的端口拓扑图显示。

经验总结
- Windows 环境下，开发阶段优先绑定到 127.0.0.1，减少防火墙相关干扰。
- 端口冲突优先通过 netstat + tasklist 精准定位进程，避免盲目尝试。
- 配置项统一集中在 config.py，便于多环境切换与快速回退。
- 重要功能修改前必须对照设计规范文档，确保实现符合要求。
- API重写时要考虑数据格式兼容性，避免前端显示异常。
- 复杂问题排查要系统性分析，从配置、代码逻辑、数据格式等多个维度检查。