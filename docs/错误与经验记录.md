错误与经验记录（持续更新）
## 2025-11-07 用户手册修订要点（记录）
- 问题与原因：
  - 用户角色与权限描述与实际使用场景不完全一致（过于笼统）。
  - 软件功能介绍遗漏“设备生命周期管理”模块。
  - 各模块操作与字段说明不够细化，审查材料可读性不佳。
- 处理与修正：
  - 参考《说明文档模板（最新版）.docx》，重构手册结构，明确角色模型与权限边界（系统管理员、资产管理员、运维工程师、观察者/审计）。
  - 新增并细化“设备生命周期管理”模块（事件类型、校验规则、操作步骤、附件管理）。
  - 按模块补充标准化小节：模块目标、入口、前置条件、操作步骤、字段说明、错误提示。
  - 更正本地预览地址为 `http://127.0.0.1:8000/topology`，避免与运行端口不一致（此前文档为 8009）。
- 风险控制：
  - 文档修订与代码无耦合变更；提交时仅包含文档修改，避免影响运行环境。
  - 保留原修订记录，便于软著审查的版本追踪。
- 后续建议：
  - 在“模块说明”章节补充关键页面截图与示例数据；
  - 与登记信息统一软件名称、版本号与日期；
  - 若引入鉴权模块，补充登录与角色配置的操作流程与截图。
记录原则
- 重要错误与异常必须记录：错误现象、原因分析、定位过程、修复方案、验证结果、回退预案。
- 重要操作与经验必须记录：要点、注意事项、通用解决路径，避免重复犯错与重复劳动。

2025-10-27 开发服务器启动策略与UI改动记录
- 现象：运行 python run.py 出现 [WinError 10013]，导致无法绑定 0.0.0.0:8009。
- 处理：通过命令行启动 Uvicorn 并改为回环地址 127.0.0.1，端口保持 8009：`python -m uvicorn main:app --host 127.0.0.1 --port 8009 --reload`。
- 结论：Windows 环境可能因策略或安全软件拦截 0.0.0.0 监听；在不需要外网访问的开发阶段，优先使用 127.0.0.1 可规避问题。
- 回退/恢复：若需对外访问或使用容器编排，请恢复为 0.0.0.0 并在防火墙中放行相应端口；也可改用反向代理。

2025-10-27 连接管理页面「设备名称」筛选交互优化
- 变更点：将纯文本输入替换为 HTML5 `datalist`，支持「输入搜索 + 下拉选择」两种方式共存。
- 实现：
  - 在 `connections.html` 添加 `datalist#deviceNameOptions`，并将 `input#deviceNameFilter` 绑定 `list` 属性。
  - 复用设备加载逻辑，汇总 `allDevices` 并动态填充选项（展示设备名与资产ID）。
  - 增加防抖函数 `debouncedLoadConnections`，减少频繁请求，提高交互流畅度。
- 注意事项：
  - `datalist` 的选项不支持滚动型选择器，建议用户输入前缀快速筛选；如需完全下拉选择体验，可后续替换为 `select + search` 组件。
  - 保持与后端 `/api/connections?device_name=` 的过滤语义一致，避免破坏既有接口。
- 验证：在本地预览 `/connections` 页面，输入或选择设备名称均可触发筛选，接口请求频率明显下降。
- 现象：用户反映端口拓扑图显示不正常，上半部分选择四层或五层时都显示上下分层图，下半部分不同布局模式显示异常。
- 初步判断：
  1) 可能存在两套代码运行导致不一致；
  2) 端口拓扑图API实现不符合设计规范；
  3) 前后端数据格式不匹配。
- 定位过程：
  1) 发现8009端口被占用，强制终止进程并统一配置；
  2) 分析端口拓扑图API实现，发现多个不符合设计规范的问题；
  3) 对照设计规范文档，确认具体偏差。
- 发现的问题：
  1) 端口名称使用 fuse_number/breaker_number 而非原始 port_name；
  2) 左右分区逻辑错误，简单按奇偶数分配而非平均分配；
  3) 缺少箭头方向控制，未根据"上下游"字段设置；
  4) 连接线颜色固定红色，未按交流/直流区分；
  5) 节点标签格式不符合规范。
- 修复方案：
  1) 统一代码执行入口，确保只有一套代码运行；
  2) 按设计规范完全重写端口拓扑图API；
  3) 实现正确的左右分区平衡算法；
  4) 根据"上下游"字段控制箭头方向；
  5) 实现正确的连接线颜色映射（交流黄色，直流红色，空闲灰色）；
  6) 优化节点标签格式（设备节点显示机房+设备名，端口节点显示原始port_name）。
- 具体改动：
  - 恢复config.py到8009端口和0.0.0.0绑定；
  - 完全重写/api/port-topology/{device_id}实现；
  - 使用原始source_port/target_port作为端口标识；
  - 实现平均分配的左右分区算法；
  - 根据upstream_downstream字段控制箭头方向；
  - 根据connection_type设置连接线颜色。
- 验证结果：
  - 服务器成功启动在8009端口；
  - /graph页面可正常访问；
  - 待进一步测试设备ID=13的端口拓扑图显示。

2025-11-03 设备管理页面「按设备名称筛选」交互优化
- 变更点：为首页设备管理的名称筛选输入框增加 HTML5 `datalist`，支持「输入搜索 + 下拉选择」。
- 实现：
  - 在 `templates/index.html` 增加 `datalist#deviceNameOptions`，为 `input#nameFilter` 绑定 `list` 属性；保留原筛选逻辑。
  - 新增 `populateDeviceNameOptions()`，从当前设备表格的第3列（设备名称）去重提取，动态写入选项。
  - 新增 `debouncedFilterDevices()` 防抖方法，默认 300ms，减少频繁 DOM 遍历，提高交互流畅度。
- 注意事项：
  - 设备列表为服务端渲染，页面初始化即可填充选项；如后续引入异步刷新，需要在刷新后再次调用 `populateDeviceNameOptions()`。
  - `datalist` 不支持复杂下拉交互，如需更丰富体验建议后续替换为可搜索下拉组件（例如 Select2）。
- 验证：本地预览 `/` 首页，输入或选择设备名称均可即时过滤；恢复筛选条件后仍可正常填充选项。
- 回退方案：
  - 若出现兼容性问题，移除 `list` 与 `datalist` 标记，并将输入事件恢复为 `onkeyup="filterDevices()"` 即可。

2025-11-03 datalist 下拉仅显示上次选项问题修复
- 现象：当输入框值与某个选项完全一致时，点击下拉只出现该选项，需手动清空才能显示全部选项。
- 页面影响：设备管理（首页）与连接管理页面的设备名称筛选。
- 原因分析：HTML5 `datalist` 在输入值为完全匹配项时会按该值严格过滤，导致只展示该项。
- 修复方案：
  - 在输入框聚焦事件中判断当前值是否与选项完全匹配，若匹配则临时清空输入值以展示全部选项，并“抑制一次防抖”避免误触发筛选。
  - 失焦时若未选择且输入仍为空，自动恢复之前的值，然后再执行筛选/加载逻辑。
- 具体实现：
  - 首页 `templates/index.html`：新增 `prepareAllDeviceNameOptions()` 与 `finalizeDeviceNameFilter()`，在 `debouncedFilterDevices()` 中增加一次性抑制标记 `__suppressFilterOnce`。
  - 连接管理 `templates/connections.html`：新增 `prepareDeviceNamePicker()` 与 `finalizeDeviceNameFilter()`，在 `debouncedLoadConnections()` 中增加一次性抑制标记 `__suppressLoadConnectionsOnce`。
- 验证：本地预览首页与 `/connections`，焦点点击下拉时均可展示全部选项；未选择时失焦可恢复原值，不影响既有筛选。

2025-11-03 厂商筛选支持“输入搜索 + 下拉选择”与聚焦清空
- 变更点：为首页厂商筛选（`input#vendorFilter`）增加 `datalist#vendorOptions`，并实现聚焦清空与失焦恢复逻辑。
- 实现：
  - `populateVendorOptions()` 从设备表格第9列采集厂商名称，去重后填充 `datalist`。
  - `prepareVendorOptions()` 在值完全匹配某选项时临时清空，并设置 `__suppressFilterOnce` 抑制一次防抖。
  - `finalizeVendorFilter()` 失焦时若为空则恢复原值，随后执行筛选。
- 验证：本地预览首页，点击厂商筛选下拉始终显示全部选项；输入或选择后可正常过滤。

经验总结
- Windows 环境下，开发阶段优先绑定到 127.0.0.1，减少防火墙相关干扰。
- 端口冲突优先通过 netstat + tasklist 精准定位进程，避免盲目尝试。
- 配置项统一集中在 config.py，便于多环境切换与快速回退。
- 重要功能修改前必须对照设计规范文档，确保实现符合要求。
- API重写时要考虑数据格式兼容性，避免前端显示异常。
- 复杂问题排查要系统性分析，从配置、代码逻辑、数据格式多个维度检查。