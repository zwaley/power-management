# 总线式端口拓扑图问题分析报告

## 问题概述

根据用户反馈，当前总线式端口拓扑图存在以下三个主要问题：

1. **输入侧/输出侧端口分类逻辑错误**
2. **缺少端口连接的对端设备显示**
3. **总线分组逻辑不支持按端口数量分组**

## 详细问题分析

### 问题1：输入侧/输出侧端口分类逻辑错误

#### 当前实现问题
- 当前的`_group_ports_by_direction`函数基于设备类型和端口名称关键词来判断端口方向
- 但这种分类是从"其他设备"的角度，而不是从"选中设备"的角度
- 例如：选中设备A的某个端口连接到设备B，该端口对设备B来说是输入端口，但对选中设备A来说应该是输出端口

#### 相关代码位置
```python
# main.py 第4196-4264行
def _group_ports_by_direction(device: Device, ports: list) -> dict:
    """按电流方向分组端口"""
    # 当前逻辑基于设备类型和端口名称关键词判断
    # 问题：没有考虑实际连接关系和电流方向
```

#### 正确逻辑应该是
- 对于选中设备，应该基于实际的连接关系和电流方向来判断端口类型
- 输出侧端口：选中设备向其他设备输出电力的端口
- 输入侧端口：选中设备从其他设备接收电力的端口
- 需要结合Connection表中的`upstream_downstream`字段来判断实际电流方向

### 问题2：缺少端口连接的对端设备显示

#### 当前实现问题
- 当前总线式拓扑图只显示了选中设备的端口，没有显示这些端口连接到哪些设备
- `_create_bus_port_edges`函数创建的是端口到端口的连接，但没有显示对端设备信息
- 用户无法直观看到设备A的端口连接到设备B的哪个端口

#### 相关代码位置
```python
# main.py 第4377-4476行
def _create_bus_port_edges(connection, direction: str) -> list:
    # 当前只创建端口间连接，没有显示对端设备
    # 缺少对端设备节点的创建和显示
```

#### 需要的改进
- 在总线式拓扑图中添加对端设备节点
- 显示"设备A端口 → 设备B端口"的完整连接关系
- 对端设备应该以简化形式显示，避免图形过于复杂

### 问题3：总线分组逻辑不支持按端口数量分组

#### 当前实现问题
- 当前按电流方向分组：输入侧、输出侧、双向
- 没有考虑端口数量限制，一个总线可能包含过多端口，导致显示效果不佳
- 用户期望能够按端口数量分组，例如每10个端口一条总线

#### 相关代码位置
```python
# main.py 第4265-4311行
def _create_bus_node(device: Device, direction: str, ports: list) -> dict:
    # 当前为每个方向创建一个总线节点
    # 没有考虑端口数量限制
```

#### 需要的改进
- 添加端口数量限制参数（如每条总线最多10个端口）
- 当某个方向的端口数量超过限制时，自动分成多条总线
- 总线命名应该反映分组信息，如"输入侧总线1"、"输入侧总线2"

## 数据结构分析

### Connection模型字段分析
```python
class Connection(Base):
    # 设备关联
    source_device_id: int  # 源设备ID
    target_device_id: int  # 目标设备ID
    
    # 端口信息
    source_fuse_number: str     # A端熔丝编号
    source_breaker_number: str  # A端空开编号
    target_fuse_number: str     # B端熔丝编号
    target_breaker_number: str  # B端空开编号
    
    # 关键字段：电流方向和层级关系
    hierarchy_relation: str     # 上下级关系（如：A上B下）
    upstream_downstream: str    # 上下游关系（如：上游、下游）
    
    # 连接类型
    connection_type: str        # 连接类型
    cable_model: str           # 电缆型号
```

### 关键字段含义
- `upstream_downstream`：表示电流方向
  - "上游"：电流从source_device流向target_device
  - "下游"：电流从target_device流向source_device
- `hierarchy_relation`：表示设备层级关系
  - "A上B下"：source_device在上级，target_device在下级

## 修复方案

### 方案1：修复端口分类逻辑
1. 修改`_group_ports_by_direction`函数
2. 基于实际连接关系判断端口方向
3. 结合`upstream_downstream`字段确定电流方向
4. 从选中设备的角度正确分类输入/输出端口

### 方案2：添加对端设备显示
1. 修改`_create_bus_topology_nodes`函数
2. 为每个连接的对端设备创建简化节点
3. 显示完整的"设备A端口 → 设备B端口"连接关系
4. 对端设备节点使用不同的视觉样式区分

### 方案3：优化总线分组逻辑
1. 添加端口数量限制参数
2. 修改`_create_bus_node`函数支持多总线分组
3. 实现智能分组算法
4. 优化总线命名和显示

## 影响评估

### 代码修改范围
- `main.py`中的总线式拓扑图相关函数（约10个函数）
- 可能需要修改前端`graph.html`中的布局配置
- 不影响数据库结构，无需数据迁移

### 风险评估
- 低风险：主要是逻辑修改，不涉及数据结构变更
- 需要充分测试以确保不影响现有功能
- 建议分步骤实施，每个问题单独修复和测试

## 实施计划

1. **第一步**：修复端口分类逻辑错误
2. **第二步**：添加对端设备显示功能
3. **第三步**：优化总线分组逻辑
4. **第四步**：全面测试和优化

每个步骤完成后进行测试，确保功能正常后再进行下一步。