# 拓扑图重构隔离与复用方案（草案 v0.1）

## 1. 背景与目标
- 现状：`/graph` 页面设备拓扑可用，但端口拓扑不稳定，维护成本高。
- 决策：新建 `/topology` 页面，专注端口拓扑重构，确保与旧代码彻底隔离，同时“可借鉴但不耦合”现有设备拓扑生成方式。
- 范围：本文件仅为规划与实施清单，不包含功能代码。

## 2. 路由与模板隔离
- 新入口：`GET /topology` → `templates/topology.html`（新模板）。
- 并存策略：保留 `/graph` 供设备级拓扑使用；端口级拓扑全部迁移至 `/topology`。
- 模板原则：`topology.html` 不内联旧版 `graph.html` 的脚本或样式；脚本仅加载新页面所需模块。

## 3. 脚本与样式隔离
- 脚本文件：
  - 新建（规划名）：`static/js/topology_ports.js`（端口拓扑渲染器）、`static/js/topology_nav.js`（导航/选择逻辑）。
  - 禁止引用：`static/js/port_topology.js`（旧端口拓扑管理器）。
- 命名空间：
  - 新页面仅暴露：`window.TopologyPage`、`window.TopologyPorts`（或等效命名）。
  - 避免使用：`window.portTopologyManager`、`currentGraphData` 等旧全局符号。
- 样式文件：
  - 使用 `static/css/topology.css`，以根选择器 `.topology-page` 进行样式作用域隔离（BEM/前缀化）。

## 4. 数据接口与契约隔离
- 端口拓扑最终接口：`GET /api/topology/ports/{device_id}`。
- 过渡别名：保留 `GET /api/port-topology/v2/{device_id}` 一段时间（后端加路由别名）。
- 设备选择接口：`GET /api/devices/list`（≤500条，前端本地搜索过滤）。
- 数据契约：沿用《端口拓扑接口契约.md》与《字段字典与别名映射.md》，页面不再依赖 `/graph` 使用的 `power-chain` 或内嵌数据结构。

## 5. 可复用点（源自设备拓扑的“生成方式”）
- 图谱技术栈：继续采用 `vis-network`（DataSet + hierarchical 布局）。
- 布局策略：沿用“分层布局（上下/左右）”与基础边样式；中心设备居中、左右分列的思路可保留。
- 文本与标签：借鉴 `graph.html` 中的标签格式化（去下划线、分行显示），但在新脚本内实现独立方法。
- 交互模型：点击/双击节点弹详情、加载遮罩/提示、全屏切换的交互方式可复用为“模式”，但事件绑定统一在新页面内完成。

## 6. 禁止与避免事项
- 新页面禁止加载 `static/js/port_topology.js`。
- 不复用 `graph.html` 中的内联脚本逻辑（包括全局变量与工具方法）。
- 不共享 LocalStorage 键名（使用新前缀，如 `tp:positions:{device}:{layout}`）。
- 不依赖 `/graph` 的筛选控件与参数拼接方案。

## 7. 避免旧代码干扰的具体操作清单
- 页面层面：
  - 新建 `templates/topology.html`，仅加载新脚本/样式；不引用旧 JS/CSS。
  - 顶层容器类名使用 `.topology-page`，避免选择器与 `graph.html` 冲突。
- 脚本层面：
  - 所有 JS 以 IIFE/模块模式封装，唯一导出对象置于 `window.Topology*` 命名空间。
  - 不声明或访问 `window.portTopologyManager`、`currentGraphData` 等旧全局。
- 接口层面：
  - 仅请求 `GET /api/topology/ports/{device_id}` 与 `GET /api/devices/list`。
  - 暂行别名 `GET /api/port-topology/v2/{device_id}` 仅作为后端兼容，不在新脚本硬编码。
- 存储与日志：
  - LocalStorage 使用新键前缀 `tp:`，避免覆写旧数据。
  - 前端错误上报统一到 `/api/log-error`（若存在），分类 `TOPOLOGY_PAGE`。

## 8. 迁移步骤（不写功能代码）
1) 新建页面与文件占位（模板/脚本/样式命名确定）。
2) 文档化接口与字段（引用契约文档，页面不改动旧路由）。
3) 导航入口指向 `/topology`，`/graph` 仍保留用于设备拓扑。
4) 上线后观察端口级渲染与日志，逐步下线 `/graph` 的端口相关 UI。

## 9. 验收标准（规划）
- `/topology` 页面仅加载新脚本与样式，无旧全局符号。
- 设备选择与端口渲染闭环基于新接口契约，数据与布局稳定。
- 全屏与详情交互在新页面内独立完成，无依赖旧事件。
- 旧页面 `/graph` 的设备拓扑不受影响。

## 10. 参考文档
- 《端口拓扑图设计规范.md》
- 《端口拓扑接口契约.md》
- 《字段字典与别名映射.md》
- 《拓扑图功能开发计划.md》