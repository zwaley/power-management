# 端口拓扑图设计规范

## 1. 概述

本文档定义了端口拓扑图的设计规范，明确了用户对端口拓扑图的具体需求，以确保开发出符合用户期望的功能。

## 2. 布局规范

### 2.1 中心化布局
- 选中的设备节点必须位于拓扑图中央位置
- 该设备节点代表用户当前查看的核心设备

### 2.2 左右分区原则
- 左右分区仅用于平衡端口展示数量，避免一侧端口过多而显示不下
- 左右分区与端口的上下游关系无关
- 根据端口总数量，将端口平均分配到左右两侧
  - 例如：设备有10个端口，则左侧显示5个，右侧显示5个
  - 如果端口数量为奇数，则左侧多显示一个或右侧多显示一个（保持平衡即可）

### 2.3 端口排列方式
- 左右两侧的端口均按照顺序自上而下排列
- 排列顺序应与数据库中端口的物理顺序一致
- 不考虑端口的上下游关系或其他业务逻辑因素

## 3. 连接线规范

### 3.1 箭头方向控制
端口连接线的箭头方向由数据库中Connection表的"上下游"字段决定：
- 当"上下游"字段值为"上游"时：
  - 箭头方向：从本端设备端口指向对端设备端口
- 当"上下游"字段值为"下游"时：
  - 箭头方向：从对端设备端口指向本端设备端口

### 3.2 连接线样式
- 交流电缆：黄色实线
- 直流电缆：红色实线
- 空闲端口：灰色虚线（无箭头）
- 连接线宽度应与额定电流成正比

## 4. 节点表示规范

### 4.1 本端设备节点
- 显示格式：机房名称 + 设备名称
- 位于拓扑图中央位置

### 4.2 本端端口节点
- 显示格式：端口名称（严格采用用户提交的原始port_name）
- 按照左右分区原则分布在本端设备节点两侧

### 4.3 对端设备节点
- 显示格式：对端设备名称 + 对端端口名称
- 仅显示与本端设备端口有直接连接关系的对端设备端口
- 不显示对端设备的其他无关端口

### 4.4 空闲端口处理
- 没有连接关系的端口仅显示本端端口节点
- 不延伸连接线至对端设备

## 5. 交互功能规范

### 5.1 显示选项
- 提供"显示所有端口"选项：显示设备的所有端口（包括空闲端口）
- 提供"只显示在用端口"选项：仅显示有连接关系的端口

### 5.2 悬停提示
- 鼠标悬停在连接线上时，显示连接详情（至少包含：电缆型号、备注）
- 鼠标悬停在节点上时，显示设备或端口的详细信息

### 5.3 点击交互
- 点击节点可查看详细信息
- 点击连接线可查看连接详情
- 连接详情至少包含：电缆型号、备注；后续可按需扩展

### 5.4 拖拽功能
- 用户可以拖拽节点或连接线进行调节
- 调整时只移动用户拖动的元素，其它任何节点和连接线等不要随之变动
- 拖拽操作应提供良好的视觉反馈

### 5.5 全屏显示
- 提供全屏显示按钮
- 点击后拓扑图应占据整个浏览器窗口
- 全屏模式下应保持所有交互功能正常

## 6. 可读性优化

### 6.1 布局算法优化
- 使用布局算法优化节点间距和连接路径
- 避免连接线交叉过多影响可读性
- 在处理多条并行连接时优先考虑层次清晰和电流路径直观

### 6.2 视觉层次
- 通过颜色、形状等视觉元素区分不同类型的节点和连接线
- 确保拓扑图整体清晰易读

## 7. 性能与渐进渲染
- 适用阈值：当本端设备端口数量 > 30 时，启用渐进渲染（阈值可通过配置调整）。
- 渐进策略：
  - 第一步：优先渲染设备与端口节点及其标签；
  - 第二步：按批次（如每批 20 条）渲染连接线与箭头；
  - 悬停/点击细节采用延迟绑定，避免首屏大量事件注册；
  - 降低阴影/动画等开销以保证交互流畅。
- 布局稳定性：首次计算布局后固定节点位置，避免重排抖动。
- 大图优化：当连接线数量 > 50 时，默认隐藏边标签，交互时临时显示。

## 8. 导出与主题
- 导出能力：支持一键导出为 SVG，确保矢量无损、文本可选中、样式内联，便于外部文档嵌入。
- 主题与配色：默认采用深色系主题，以提升对比度与可读性：
  - 背景：#0F1220；文本：#E6E9EF；网格/辅助线：#2B2F3A；
  - 交流电缆：#F0C419（金黄）；直流电缆：#E74C3C（红）；空闲：#7F8C8D（灰）；
  - 对比度满足可读性（AA 级）优先；预留主题切换能力。
- 导出一致性：导出 SVG 与屏显一致；导出时自动去除交互句柄与 hover 高亮等临时样式。
- 文件命名：port-topology-<device-name>-<yyyyMMdd-HHmmss>.svg。
# 端口拓扑图设计规范

## 一、核心数据来源与行语义
- 数据源为用户上传的“连接”表；一行代表一个“端口占用情况”。
- 每行的 A 端仅会出现一个“空开或熔丝”（即一个端口）。
- 若该端口在用，则同一行会出现对应的 B 端设备的“空开或熔丝”（对端端口），且“电缆类型”字段会有值。
- 若该端口空闲，则同一行“B 端空开/熔丝”和“电缆类型”字段均为空。

## 二、连线绘制规则（严格按行）
- 仅当“电缆类型”字段不为空时，绘制端口到端口的连线：连接该行的 A 端端口与 B 端端口。
- 当“电缆类型”字段为空时，不绘制任何连线，仅绘制该行的 A 端端口节点。
- 禁止任何“自动匹配/自动补线”行为；不得根据布局或推断补画边。

## 三、箭头方向规则（上下游）
- 读取该行“上下游”字段：
  - “上游”：箭头从 A 端指向 B 端。
  - “下游”：箭头从 B 端指向 A 端。
- 前端不得覆盖后端提供的箭头方向；若后端未提供，则默认箭头指向 `to` 节点（由后端的 `from/to` 定义决定）。

## 四、渲染可视风格（最小要求）
- 连线统一以醒目描边渲染（当前为红色、线宽≥4）以确保可见性；颜色策略可根据“交流/直流”等后续规范拓展，但不影响上述连线与箭头规则。
- 端口节点始终可见；当行为空闲（电缆类型为空）时，仅显示 A 端端口节点。

## 五、服务重启与端口约定
- 修复或更新代码后，重启服务一律使用 `8009` 端口。
- 若 `8009` 端口被占用：先杀掉占用该端口的进程，再以 `8009` 端口重启服务。
- 重启流程示例（Windows 环境）：
  - 查询端口占用：`netstat -ano | findstr :8009`
  - 杀进程：`taskkill /F /PID <占用PID>`
  - 启动服务（示例）：`python run.py`（确保服务监听 `8009`）

## 六、实现要点（前后端协同）
- 后端：按行构造 `from/to` 端口及 `arrows`（基于“上下游”）；仅当“电缆类型”非空时输出该条边。
- 前端：
  - 过滤：仅渲染 `cable_type/cable_model` 非空的边。
  - 箭头：优先尊重后端边对象中的 `arrows`，不要强行覆盖。
  - 禁用任何自动补线逻辑，保持与数据一致。

以上规则为强约束，任何偏离将导致拓扑与数据不一致。