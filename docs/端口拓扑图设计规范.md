# 端口拓扑图设计规范

## 1. 概述

本文档定义了端口拓扑图的设计规范，明确了用户对端口拓扑图的具体需求，以确保开发出符合用户期望的功能。

## 2. 布局规范

### 2.1 中心化布局

- 选中的设备节点必须位于拓扑图中央位置
- 该设备节点代表用户当前查看的核心设备

### 2.2 左右分区原则

- 左右分区仅用于平衡端口展示数量，避免一侧端口过多而显示不下
- 左右分区与端口的上下游关系无关
- 根据端口总数量，将端口平均分配到左右两侧
  - 例如：设备有10个端口，则左侧显示5个，右侧显示5个
  - 如果端口数量为奇数，则左侧多显示一个或右侧多显示一个（保持平衡即可）

### 2.3 端口排列方式

- 左右两侧的端口均按照顺序自上而下排列
- 排列顺序应与数据库中端口的物理顺序一致
- 不考虑端口的上下游关系或其他业务逻辑因素

## 3. 连接线规范

### 3.1 箭头方向控制

端口连接线的箭头方向由数据库中Connection表的"上下游"字段决定：

- 当"上下游"字段值为"上游"时：
  - 箭头方向：从本端设备端口指向对端设备端口
- 当"上下游"字段值为"下游"时：
  - 箭头方向：从对端设备端口指向本端设备端口

### 3.2 连接线样式

- 交流电缆：黄色实线
- 直流电缆：红色实线
- 空闲端口：灰色虚线（无箭头）
- 连接线宽度应与额定电流成正比

## 4. 节点表示规范

### 4.1 本端设备节点

- 显示格式：机房名称 + 设备名称
- 位于拓扑图中央位置

### 4.2 本端端口节点

- 显示格式：端口名称（严格采用用户提交的原始port_name）
- 按照左右分区原则分布在本端设备节点两侧

### 4.3 对端设备节点

- 显示格式：对端设备名称 + 对端端口名称（合并为一个节点显示）
- 展示策略：采用“单节点合并”模式，只显示与本端设备端口有直接连接关系的对端端口；不再额外绘制“对端设备”的独立节点。
- 目的：减少节点数量、提升可读性；对端设备名称作为该端口节点标签的一部分，同时保留到 `meta.device_name` 便于详情展示。

### 4.4 空闲端口处理

- 没有连接关系的端口仅显示本端端口节点
- 不延伸连接线至对端设备

## 5. 交互功能规范

### 5.1 显示选项

- 提供"显示所有端口"选项：显示设备的所有端口（包括空闲端口）
- 提供"只显示在用端口"选项：仅显示有连接关系的端口

### 5.2 悬停提示

- 鼠标悬停在连接线上时，显示连接详情（至少包含：电缆型号、备注）
- 鼠标悬停在节点上时，显示设备或端口的详细信息

### 5.3 点击交互

- 点击节点可查看详细信息
- 点击连接线可查看连接详情
- 连接详情至少包含：电缆型号、备注；后续可按需扩展

### 5.4 拖拽功能

- 用户可以拖拽节点或连接线进行调节
- 调整时只移动用户拖动的元素，其它任何节点和连接线等不要随之变动
- 拖拽操作应提供良好的视觉反馈

### 5.5 全屏显示

- 提供全屏显示按钮
- 点击后拓扑图应占据整个浏览器窗口
- 全屏模式下应保持所有交互功能正常

## 6. 可读性优化

### 6.1 布局算法优化

- 使用布局算法优化节点间距和连接路径
- 避免连接线交叉过多影响可读性
- 在处理多条并行连接时优先考虑层次清晰和电流路径直观

### 6.2 视觉层次

- 通过颜色、形状等视觉元素区分不同类型的节点和连接线
- 确保拓扑图整体清晰易读

## 7. 性能与渐进渲染

- 适用阈值：当本端设备端口数量 > 30 时，启用渐进渲染（阈值可通过配置调整）。
- 渐进策略：
  - 第一步：优先渲染设备与端口节点及其标签；
  - 第二步：按批次（如每批 20 条）渲染连接线与箭头；
  - 悬停/点击细节采用延迟绑定，避免首屏大量事件注册；
  - 降低阴影/动画等开销以保证交互流畅。
- 布局稳定性：首次计算布局后固定节点位置，避免重排抖动。
- 大图优化：当连接线数量 > 50 时，默认隐藏边标签，交互时临时显示。

## 8. 导出与主题

- 导出能力：支持一键导出为 SVG，确保矢量无损、文本可选中、样式内联，便于外部文档嵌入。
- 主题与配色：默认采用深色系主题，以提升对比度与可读性：
  - 背景：#0F1220；文本：#E6E9EF；网格/辅助线：#2B2F3A；
  - 交流电缆：#F0C419（金黄）；直流电缆：#E74C3C（红）；空闲：#7F8C8D（灰）；
  - 对比度满足可读性（AA 级）优先；预留主题切换能力。
- 导出一致性：导出 SVG 与屏显一致；导出时自动去除交互句柄与 hover 高亮等临时样式。
- 文件命名：port-topology-<device-name>-<yyyyMMdd-HHmmss>.svg。
  
  # 端口拓扑图设计规范

## 一、核心数据来源与行语义

- 数据源为用户上传的“连接”表；一行代表一个“端口占用情况”。
- 每行的 A 端仅会出现一个“空开或熔丝”（即一个端口）。
- 若该端口在用，则同一行会出现对应的 B 端设备的“空开或熔丝”（对端端口），且“电缆类型”字段会有值。
- 若该端口空闲，则同一行“B 端空开/熔丝”和“电缆类型”字段均为空。

## 二、连线绘制规则（严格按行）

- 仅当“电缆型号”字段不为空时，绘制端口到端口的连线：连接该行的 A 端端口与 B 端端口。
- 当“电缆型号”字段为空时，不绘制任何连线，仅绘制该行的 A 端端口节点。
- 禁止任何“自动匹配/自动补线”行为；不得根据布局或推断补画边。

## 三、箭头方向规则（上下游）

- 读取该行“上下游”字段：
  - “上游”：箭头从 A 端指向 B 端。
  - “下游”：箭头从 B 端指向 A 端。
  - “平级”：不绘制箭头（`arrows` 为空）。
- 前端不得覆盖后端提供的箭头方向；若后端未提供，则默认箭头指向 `to` 节点（由后端的 `from/to` 定义决定）。
  - 当为“平级”时，必须不绘制箭头。

## 四、渲染可视风格（最小要求）

- 连线统一以醒目描边渲染（当前为红色、线宽≥4）以确保可见性；颜色策略可根据“交流/直流”等后续规范拓展，但不影响上述连线与箭头规则。
- 端口节点始终可见；当行为空闲（电缆类型为空）时，仅显示 A 端端口节点。

## 五、服务重启与端口约定

- 修复或更新代码后，重启服务一律使用 `8009` 端口。
- 若 `8009` 端口被占用：先杀掉占用该端口的进程，再以 `8009` 端口重启服务。
- 重启流程示例（Windows 环境）：
  - 查询端口占用：`netstat -ano | findstr :8009`
  - 杀进程：`taskkill /F /PID <占用PID>`
  - 启动服务（示例）：`python run.py`（确保服务监听 `8009`）

## 六、实现要点（前后端协同）

- 后端：按行构造 `from/to` 端口及 `arrows`（基于“上下游”）；仅当“电缆型号型”非空时输出该条边。
- 前端：
  - 过滤：仅渲染 `cable_type/cable_model` 非空的边。
  - 箭头：优先尊重后端边对象中的 `arrows`，不要强行覆盖。
  - 禁用任何自动补线逻辑，保持与数据一致。

以上规则为强约束，任何偏离将导致拓扑与数据不一致。\n\n## 9. 更新与简化（2025-10-13）\n\n基于最新需求，进行以下简化：\n- 布局：仅使用左右分区布局，不采用力导向布局或上下布局。\n- 连接线：统一线宽，不再与额定电流成正比。\n- 展示方式：设备拓扑图和端口拓扑图在同一个容器中展示，仅需区分设备级和端口级拓扑图，不分1-5层。\n- 全屏显示功能保留。

## 10. 现状总览与问题根因（2025-10-15）

- 后端入口：`main.py` 暴露 `GET /api/port-topology/{device_id}`，调用 `PortTopologyService.get_port_topology_data()` 构造 `nodes/edges`。
- 前端渲染：`templates/graph.html` 配合 `static/js/port_topology.js` 使用 `vis-network` 渲染。
- 问题根因：
  - 边过滤条件复杂且依赖字符串匹配，稍有命名/前缀不一致即被误过滤；随后通过回退补边掩盖问题，导致图“看起来没变化”。
  - 本地已保存坐标会在“重新生成”时继续应用，造成布局不变的观感。
  - 节点/边的字段命名不统一（`nodeType/type/node_type`、`connection_type/cable_type` 等），前端进行过度兼容与猜测。

## 11. 重构总体方案（V2 并行）

- 并行推出 `GET /api/port-topology/v2/{device_id}`，返回规范化的 DTO；保留现有接口以避免影响现网。
- 新前端页面 `templates/graph_v2.html` 仅加载 `static/js/port_topology_v2.js`，与旧版完全隔离，杜绝互相干扰。
- 目标：后端统一语义与ID，前端只渲染不补线；布局稳定、交互简洁。

## 12. 数据模型与 ID 规范（V2 DTO）

- 节点 `nodes[]`
  - `id`：强命名空间（示例）`device:{id}`、`port:{deviceId}:{portKey}`。
  - `type`：`device|port|bus|junction`。
  - `label`：端口节点（含远端）支持“设备名称 + 端口名称”的合并显示；本端端口仅显示 `port_name`。
  - `groupHint`：`center|left|right`（用于左右分区）。
  - `orderHint`：分区内排序（整数，按物理端口顺序）。
  - `position`：可选 `{x,y}`；缺失时由前端布局器计算。
  - `meta`：设备型号、站点、端口规格等（悬停/详情使用）。
- 边 `edges[]`
  - `id`：`edge:{from}->{to}:{connectionId或hash}`（仅需在边集合内唯一）。
  - `kind`：`structural|connection`（结构性边/真实连接边）。
  - `from`、`to`：节点ID。
  - `arrows`：方向定义（优先使用后端提供；当 `direction=peer` 时为空）。
  - `connection`：可选对象，最小集合 `{id,direction}`；`direction` 取值：`upstream|downstream|peer`。其余如 `{model,type,inUse}` 可按需补充。
  - `style`：可选 `{color,width}`；V2 首期统一样式，后续扩展。
- 说明：
  - `nodes.id` 与 `edges.id` 处于不同集合，不会冲突；采用前缀命名进一步降低混淆。
  - `connection.id` 仅用于“真实连接边”，结构性边不需要该字段。

## 13. 边类型与生成规则

- 结构性边（`kind=structural`）：
  - 作用：用于布局锚定设备→端口关系，保证端口节点与设备居中节点的关联。
  - 生成：仅在“本端设备→本端端口”生成 `device:{id}` → `port:{deviceId}:{portKey}` 的无箭头、无标签边；远端不生成结构性边，以减少冗余，由真实连接边表达对端关联。
  - 特征：不包含 `connection.id`，不表达 A↔B 真实连通。
- 真实连接边（`kind=connection`）：
  - 条件：仅当该行“电缆型号/类型”非空时生成。
  - 端点：`port:{A_device}:{A_portKey}` → `port:{B_device}:{B_portKey}`。
  - 方向：由“上下游”字段决定（上游：A→B；下游：B→A；平级：无箭头，`direction=peer`）。
  - 标识：包含稳定唯一的 `connection.id`（见下文算法）。
- 为什么不能用结构性边替代真实连接边：结构性边没有 B 端端口、没有方向与电缆语义，无法表达真实连接关系与交互需求。

## 14. 布局与尺寸规范（V2 简化）

- 布局：中心设备居中；左右分列仅用于数量均衡，与上下游无关；远端节点置于各自端口外侧。
- 排序：端口按物理顺序（如 `BF1,BF2,F1…F8…`）从上到下排列；奇数时单侧多一个即可。
- 尺寸：端口节点显著缩小（推荐 `size≈16~20`），仅显示端口名称；设备节点维持清晰可读即可。
- 样式：首期统一边颜色与线宽（不区分交流/直流），确保“有线就行”。

## 15. 交互与事件（V2）

- 单击节点：打开侧栏或弹窗展示该节点详情（设备或端口）；适合截图与留档。
- 单击连接线：展示连接详情（至少包含电缆型号、备注、方向）。
- 悬停提示：可选保留；若影响截图则作为辅助，不影响单击详情。
- 拖拽：仅移动用户拖拽的元素，禁用联动重排；提供保存/清空位置入口。

## 16. 并行改造与隔离策略

- 新接口：`GET /api/port-topology/v2/{device_id}` 返回本文档所述 DTO（接口名称保持 v2 以便区分）。
- 新页面：`templates/topology.html`；仅引用 `static/js/topology.js` 与必要样式。
- 隔离保障：Topology 页面不加载旧版脚本；导航提供“拓扑图（Topology）”独立入口；现网继续使用 V1。
- 端口约定：服务监听 `8009`；若占用请按照文档第 5 节处理。

## 18. 重构前准备事项（Checklist）

- 明确 DTO 契约：字段名、取值范围、`direction` 三态（upstream/downstream/peer）、ID 规则与清洗规范。
- 样例数据固化：选取 1 台设备的 8–20 条典型行，导出为 JSON fixture（不改后端代码，仅用于前端静态渲染验证）。
- 字段映射自测：按“附录 B”逐列核对，确保每种组合（熔丝/空开、上游/下游/平级、空闲）均覆盖。
- 箭头与无箭头用例：至少包含“平级”行，验证 `arrows` 为空且交互正常。
- 布局细节：端口节点尺寸与标签长度检查；左右分列与排序一致性；拖拽保存/清空位置策略在页面层面设计。
- 性能边界：>50 条连接的隐藏标签策略与渐进渲染节奏确定；事件绑定延迟方案。
- 风险与回退：异常行（缺端口名/型号）的记录与提示文案；Topology 页面回退到只显示结构性边的兜底方案。

## 19. 接口命名决议与迁移计划（最终）

- 最终命名（易懂版）：`GET /api/topology/ports/{device_id}`。
  - 含义明确：`topology`（拓扑）+ `ports`（端口）。
  - 适用于端口级拓扑；后续如需设备级拓扑，可采用 `GET /api/topology/devices/{device_id}`。
- 过渡命名（现状保持）：`GET /api/port-topology/v2/{device_id}`。
  - 目前代码仍使用该路径；为避免改动现网，短期内保留。
  - 等新页面稳定后，再将页面改为调用最终命名，同时保留旧路径作为别名一段时间。
- 迁移步骤（不改代码版本）：
  1）文档采用最终命名并说明含义；
  2）上线前，在后端添加路由别名，将最终命名与现有 v2 同时可用；
  3）前端新页面切换到最终命名；
  4）观察一段时间后下线旧命名。

## 20. 用户操作指南（零基础）

为确保后续重构顺利，您需要准备以下资料与文件。全部是“整理与放置”，不需要编程。

- 准备一份最小样例数据（用于静态验证）：
  
  - 在 Excel 里筛选出“同一台 A 端设备”的 8–20 行连接（包含上游/下游/平级三种情况，尽量有交流/直流各一两条）。
  - 另存为 `CSV（逗号分隔）` 格式，文件命名为 `topology_fixture_sample.csv`。
  - 将该文件放到项目目录 `temp/` 中（完整路径：`temp/topology_fixture_sample.csv`）。
  - 告诉我文件已就位；我会据此生成 JSON fixture 并用于前端页面的静态渲染验证。

- 照片与备注（可选）：
  
  - 若“设备照片”或“备注”列有有用信息，请原样保留在 Excel 中即可；不需要另做处理。

- 标签格式偏好（可不做）：
  
  - 我已决定远端节点标签为“设备名称 + 端口名称”（中间空格）。如有更偏好的样式（例如中划线或括号），只需在这里留言即可，我会在文档中统一样式描述。

- 数据质量自检（简单核对）：
  
  - “上下游”列只允许出现“上游/下游/平级”三种；若有其他写法，请在 Excel 中改为这三种之一（例如“同级”改为“平级”）。
  - A/B 端的“熔丝编号/空开编号”至少需要有一个不为空；若均为空，请在 Excel 备注列补充说明“端口名缺失”，我会在生成时归入异常清单。

- 文件投放位置约定：
  
  - 示例 CSV：`temp/topology_fixture_sample.csv`（您只需把文件放进去）。
  - 后续我会在同一目录放置 `topology_fixture_sample.json`（自动生成），用于前端页面验证。

- 验收要点（到时候打开新页面检查）：
  
  - 远端节点是否显示为“设备名称 + 端口名称”的单节点；
  - 上游/下游箭头方向是否正确；平级是否无箭头；
  - 空闲端口是否只显示本端端口节点，不延伸连线；
  - 大于 50 条连接时是否默认隐藏边标签，交互时临时显示。

说明：以上步骤不涉及任何代码改动，均为资料准备与文件放置。一旦样例 CSV 就位，我会继续推进“静态页面验证”并在文档追加验收结果与下一步计划。

## 17. 风险控制与验证计划

- 数据质量：必须保证每条在用连接可生成稳定 `connection.id`；缺失时进入“异常列表”，前端不做猜测补线。
- 兼容性：通过服务层映射现有模型到 V2 DTO，不改动连接关系管理模块的存储结构。
- 验证：
  - 单设备样例比对：确认端口数、连接数、方向均一致；
  - 大图性能：>200 节点下首屏渲染与交互流畅；
  - 渐进渲染：当端口数>30时按第 7 节策略执行。
  - 箭头校验：包含“上游/下游/平级”的三种情况，确保“平级”边无箭头。

## 附录 A：问答决议（2025-10-15）

- 1）唯一连接 ID 如何生成？
  - 仅为“真实连接边”分配 `connection.id`；结构性边不需要。
  - 优先复用现有 `Connection` 表的主键/唯一键；若无则按行构造稳定 ID：
    - 规范化字段：`A_device_id`、`A_port_name`、`B_device_id`、`B_port_name`、`cable_model`、`上下游`（去空白、统一括号与大小写）。
    - 组合字符串后计算哈希（如 `sha1` 截断 16 字节），形成 `connection.id`；该算法只读，无需更改数据库。
- 2）新模型字段是否与现有模块冲突？
  - 不冲突：通过服务层 DTO 映射实现；存储层与连接关系管理模块保持不变。
  - `nodes.id` 与 `edges.id` 在各自集合内唯一即可；使用前缀避免混淆。`connection.id` 仅用于真实连接边。
- 3）结构性边 vs 真实连接边的判断与用途？
  - 结构性边：设备→端口，始终存在，用于布局锚定；无箭头，无 `connection.id`。
  - 真实连接边：端口↔端口，只有在“电缆型号/类型”非空时存在；按照“上下游”确定箭头；当为“平级”时不绘制箭头；必须带 `connection.id`。
- 4）布局是否强制左右分列？
  - 是。V2 坚持中心设备居中、左右分列均衡的布局；对端节点置于对应端口外侧。
- 5）端口节点尺寸与标签？
  - 明显缩小至 `size≈16~20`，标签仅显示原始 `port_name`。
- 6）交流/直流区分是否保留？
  - 首期不区分；统一颜色与线宽。后续再按需要扩展。
- 7）`connection` 对象的必要性与来源？
  - 最小必需：`id`（稳定标识）、`direction`（由“上下游”得出）。
  - 可选：`model`（电缆型号，用于详情）、`inUse`（由型号/类型非空判断）、`type`（交流/直流，后续使用）。全部来源于连接表的同一行。
- 8）交互方式以单击为主？
  - 采用“单击展示详情”为主；悬停为辅。确保可截图与留档。
- 9）重写如何处理旧代码？
  - 采取并行方案：新路由+新页面+新脚本；V2 页面不加载 V1 脚本，避免干扰。稳定后逐步下线旧版入口。
- 10）本文档更新情况？
  - 已补充现状总览、重构方案、模型与边规则、交互与布局、风险与问答决议；本文件作为后续重构的指南与准绳。
    
    ## 附录 B：字段映射清单（V2 DTO）

以下映射基于用户提交的“连接表”（见附图一）的列。目标是从单行构造端口拓扑的节点与边，并保证含义稳定、一致。

### B1. 行是否生成“真实连接边”

- 以“电缆型号”列（K）为准：非空则生成端口↔端口的真实连接边；为空则不生成（仅生成结构性边用于布局）。

### B2. 方向与箭头

- “上下游”列（I）：
  - 上游 → `connection.direction=upstream`，`arrows='to'`（A→B）。
  - 下游 → `connection.direction=downstream`，`arrows='to'`（B→A）。
  - 平级 → `connection.direction=peer`，`arrows` 为空（不绘制箭头）。
- “上下级”列（H）：仅作补充语义，V2 首期不参与箭头与布局逻辑，可记录到 `edges.connection.meta` 以备查询。

### B3. 设备节点（nodes，type='device'）

- A端设备名称（B）：
  - 作为中心设备节点：`id='device:{A_device_id或规范化名称}'`，`label='局站+设备名称'`（局站见 A）。
  - `meta.station` ← 局站（A）；`meta.device_name` ← 设备名称（B）。
- B端设备名称（L）：
  - 作为远端设备节点：`id='device:{B_device_id或规范化名称}'`，`label='设备名称'`；
  - `meta.location` ← B端设备位置（R）（如有）。
- 设备照片（S/T）：可选，记录到 `meta.photo_url`（若后续需要显示）。

### B4. 端口节点（nodes，type='port'）

- A端端口名称：优先取熔丝编号（C），为空时取空开编号（F）。
  - `id='port:{A_device}:{A_port_name}'`，`label=A_port_name`；
  - `meta.port_type`：`fuse`（来自 C/D）或 `breaker`（来自 F/G）。
  - `meta.spec`：来自熔丝规格（D）或空开规格（G）。
  - `meta.rated_current`：A端额定电流（E）。
- B端端口名称：优先取熔丝编号（M），为空时取空开编号（P）。
  - `id='port:{B_device}:{B_port_name}'`，`label=B_port_name`；
  - `meta.port_type`：`fuse`（N）或 `breaker`（Q）。
  - `meta.spec`：熔丝规格（N）或空开规格（Q）。
  - `meta.rated_current`：B端额定电流（O）。
- 布局提示：
  - `groupHint`：中心设备端口按左右均衡分列；A端端口通常置于设备两侧，B端端口置于更外层。
  - `orderHint`：按端口名称中的序号（如 BF1、F3）提取数字排序；无法解析时按行顺序。

### B5. 边（edges）

- 结构性边（device→port）：
  - 对每个 A 端端口生成 `device:{A}` → `port:{A}:{A_port}` 的边；对 B 端端口同理（如需要显式关联）。
  - `kind='structural'`，无箭头，无 `connection.id`。
- 真实连接边（port↔port）：
  - `from='port:{A}:{A_port}'`，`to='port:{B}:{B_port}'`；
  - `kind='connection'`；`arrows` 根据 I（平级为空）；
  - `connection`：
    - `id`：稳定唯一ID；优先用连接表主键；兜底为 `sha1(normalize(A_device)+A_port+normalize(B_device)+B_port+K电缆型号+I上下游)` 的前 16 字节十六进制；
    - `direction`：`upstream|downstream|peer`（来自 I）。
    - `model`：电缆型号（K）。
    - `type`：连接类型（交流/直流）（J）— 首期不用于样式，仅用于详情。
    - `remark`：备注（U）。
    - `meta`：可附带“上下级”（H）等辅助信息。
  - `style`：统一色宽（首期）；后续可按 `type` 扩展。

### B6. 其他字段的处理

- 局站（A）：用于设备节点的 `meta.station`，也可拼入中心设备 `label`。
- B端设备位置（R）：记录到远端设备 `meta.location`，供详情显示；不影响布局。
- 设备照片（S/T）：若存在可存为 URL 字段；前端展示暂不启用。

### B7. 特殊与异常

- 当 C/F、M/P 均为空时：视为数据异常，该行无法构造端口节点；进入异常清单，不生成连接边。
- 当 K 为空但 I 为“上游/下游/平级”之一：仍不生成真实连接边，只保留端口节点与结构性边。
- 当 I 缺失或无效：`direction` 设为 `peer`，`arrows` 为空；日志记录待补数据。

## 附录 C：重构前最终准备清单（执行版）

- 数据与契约
  
  - 锁定 V2 DTO 字段、ID 规则、`direction` 三态与箭头规则（已完成）。
  - 固化最小样例：`temp/topology_fixture_sample.json` 覆盖 BF1、BF2、F1–F25；上游箭头、平级无箭头；空闲端口仅结构性边（已完成）。
  - 可选：为空闲端口添加 `nodes[].meta.idle=true` 用于灰显；当前未启用，待确认后追加（待确认）。

- 页面与脚本
  
  - 新建页面 `templates/topology.html` 与脚本 `static/js/topology.js`；页面仅加载新脚本，避免与旧版互相干扰（待建）。
  - 加载策略：支持 `?fixture=1` 从 `temp/topology_fixture_sample.json` 加载，进行静态渲染验证（待建）。

- 后端路由
  
  - 保留现有 `GET /api/port-topology/v2/{device_id}`；新增别名 `GET /api/topology/ports/{device_id}` 作为最终命名（待建）。
  - 新页面稳定后切换到最终命名；观察一段时间后下线旧命名（计划）。

- 验收项
  
  - 远端“设备名称 + 端口名称”合并标签显示一致，`meta.device_name` 保留设备名。
  - 箭头校验：上游/下游边 `arrows='to'`；平级边 `arrows=''`（无箭头）。
  - 空闲端口策略：不生成真实连接边，仅生成结构性边（已在 fixture 枚举 F9–F25）。
  - 性能与交互：>50 条连接默认隐藏边标签，单击弹出详情，拖拽不联动重排。

- 隔离与回退
  
  - Topology 页面与旧版完全隔离；异常时可退化为仅显示结构性边的兜底模式。
  - 保留旧入口与旧脚本，定位阶段可随时切回旧版。

- 职责分工
  
  - 用户：审核 fixture（节点/边/箭头/异常项）并反馈；确认标签样式偏好、是否灰显空闲端口、是否展示备注/照片等附加信息。
  - 开发：完成新页面与脚本、路由别名、静态验证、文档更新与迁移执行。

## 附录 D：静态验证计划（Fixture v1）

- 准备
  
  - 使用id为13的设备 `temp/topology_fixture_sample.json`（最新已覆盖 BF1、BF2 与 F1–F25）。
  - 如需扩大覆盖面，可在 CSV 中增补“下游”样例，生成下一版 fixture。

- 加载与渲染（规划）
  
  - 新建 `templates/topology.html`，支持 `?fixture=1` 加载本地 fixture。
  - 仅渲染 V2 DTO，不做自动补线或猜测。

- 用例清单
  
  - 平级：BF1→蓄电池01、BF2→蓄电池02，`arrows=''`（无箭头）。
  - 上游：F1–F8 至 A18/B18/D01/C18，`arrows='to'`。
  - 空闲：F9–F25 仅结构性边，无任何 `kind='connection'` 边。
  - 异常：如端口名缺失或电缆型号缺失但非空闲规则的行进入异常清单，不绘制连接。

- 验收输出
  
  - 截图：全图与关键子图，标注样例位置。
  - 清单：节点数、边数、各类边计数（上游/下游/平级）、箭头状态统计。
  - 文档：在本规范追加“静态验证结果与问题清单（v1）”，作为迁移前置条件。