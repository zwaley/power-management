# 全局设备拓扑接口契约

本文档描述“全局设备图”后端接口与前端使用方式，作为新增功能的说明与后续维护参考。

## 接口概览

- 路由：`GET /api/topology/global`
- 说明：返回设备级无方向拓扑图，包含去重后的设备节点与连接边。
- 查询参数：
  - `station`（可选，字符串）：按站点过滤；为空时返回所有站点。
  - `device_type`（可选，字符串）：按设备类型过滤；为空时返回所有类型。

## 响应格式

```json
{
  "nodes": [
    { "id": 101, "label": "设备名（或型号/厂商简化）" },
    { "id": 102, "label": "设备名B" }
  ],
  "edges": [
    { "from": 101, "to": 102, "label": "DC" },
    { "from": 102, "to": 103, "label": "AC" }
  ]
}
```

- `nodes`：设备节点；`id` 为设备ID；`label` 为显示名称；可包含 `title` 等可选字段。
- `edges`：设备间连接；`label` 一般为连接类型（如 `AC`/`DC`）。
- 注意：接口对 `from`/`to` 进行规范化与去重（同一对设备多条边仅保留一条）。

## 前端集成

- 脚本：`static/js/topology_global.js`
  - 负责请求接口、数据转换为 `vis.js` 的 `nodes/edges`、布局与交互配置。
  - 支持两种布局：
    - `standard`：力导向（`forceAtlas2Based`），适合分散探索。
    - `bus`：层级（左右方向），适合汇聚查看。
  - 交互：点击/悬停节点会在左侧详情面板显示设备信息（`TopologyPage.updateDetails`）。

- 页面：`templates/topology.html`
  - 在左侧 `层级` 下拉框中选择 `全局设备图` 来切换模式；配合 `布局` 下拉框进行布局切换。
  - 默认不设置 `station/device_type` 选择框；如需过滤，可在页面添加相应选择控件，并由 `topology_global.js` 读取其值：
    - `#station-select`、`#device-type-select`（可选）。

## 使用示例

- 请求所有设备的全局图：
  - `GET /api/topology/global`
- 按站点过滤：
  - `GET /api/topology/global?station=新农楼一楼综合机房`
- 按设备类型过滤：
  - `GET /api/topology/global?device_type=空调`
- 组合过滤：
  - `GET /api/topology/global?station=新农楼&device_type=整流`

## 注意事项与边界

- 无方向图设计：为避免误导，边上不绘制箭头；`label` 仅显示连接类型。
- 大图性能：节点、边数较大时建议使用层级布局或适度过滤；前端物理参数已做稳态与速度限制。
- 详情面板：前端会尝试从已加载设备列表中补全点击节点的厂家、型号、容量等信息；如设备列表缺失，将仅显示节点标签。

## 变更记录

- v1.0.0：新增接口与前端脚本；模板加入“全局设备图”选项；控制脚本兼容新模式。