# 重要错误与经验记录（全局拓扑）

更新时间：2025-11-03

## 问题1：全局拓扑出现“nan”设备
- 症状：拓扑图中存在标签为 `nan` 的设备节点。
- 影响：误导用户判断，拓扑关系被“虚化”。
- 根因分析：
  - 数据导入时将空设备名转换为字符串 `nan`（常见于 Excel/Pandas 导入）。
  - 后端未对无效设备名进行过滤，导致生成节点；前端容错逻辑又将空值转成字符串显示。
- 修复方案（已实施）：
  - 后端：在 `/api/topology/global` 中过滤无效设备名（空/None/`nan`/`na`/`null`/`none`），并仅在双方节点有效时生成边，避免隐式补节点。
  - 前端：在 `static/js/topology_global.js` 中过滤无效标签，确保不渲染异常节点。
- 验证要点：
  - 访问 `http://127.0.0.1:8009/topology`，选择“全局设备图”，确认不再出现 `nan` 标签节点。
  - 对应连接边数量与实际数据一致，不出现“悬空边”。
- 回退策略：
  - 仅回退前端：移除 `toVisData` 的标签过滤。
  - 仅回退后端：恢复 `add_device_node` 的原始检查，取消标签过滤；注意此举会重新出现 `nan` 节点。

## 问题2：拖动节点导致整体拓扑“浮动”
- 症状：拖动任意节点时，整个图随物理引擎漂移，难以固定位置。
- 根因分析：
  - 全局模式默认启用了 `vis-network` 的物理引擎（`forceAtlas2Based`/`hierarchicalRepulsion`）。
  - 未在渲染后将节点设置为固定（`fixed: { x: true, y: true }`）。
- 修复方案（已实施）：
  - 前端：关闭物理引擎（`physics.enabled = false`），渲染后遍历所有节点设置 `fixed: { x: true, y: true }`；保留 `dragNodes: true` 以支持手动拖拽与微调。
  - Bus（层级）布局同样禁用物理引擎，避免稳定化阶段整体漂移。
- 验证要点：
  - 拖拽单个节点时，其他节点保持不动；拖拽后的位置不会自动回弹或继续漂移。
  - 切换布局后，节点仍保持固定拖拽行为。
- 回退策略：
  - 临时开启物理引擎：在 `topology_global.js` 中将 `physics.enabled` 改为 `true`，仅用于排查布局拥挤时的自动分散效果，排查后再关闭。

## 关联文件与修改位置
- 后端：`main.py` 路由 `GET /api/topology/global`
  - 过滤无效设备名：`add_device_node` 中对 `nm.lower()` 进行集合判断。
  - 边生成保护：仅当 `sd.id` 与 `td.id` 均在 `nodes_map` 中时，才生成边。
- 前端：`static/js/topology_global.js`
  - 默认关闭物理引擎；渲染后固定全部节点；过滤无效标签。

## 经验教训
- 数据容错要在“源头”（后端）优先处理，前端仅做保底过滤，避免“看起来正常”的假象。
- 力导布局适合探索态，但在运营态（需要可控布局）应关闭物理引擎并固定节点。
- 添加保护性逻辑（如边生成前的节点有效性检查）可以避免“隐式补节点”的副作用。

## 验收与下一步
- 验收：
  - “nan”节点不再出现；拖拽单节点不影响整体布局；页面无控制台报错。
- 建议后续：
  - 增加“保存布局”与“重置布局”按钮，以便将用户拖拽后的坐标存储/恢复。
- 在文档《全局设备拓扑接口契约.md》中补充“无效设备名过滤规则”的说明（已在代码实现）。
 
---

## 设备级拓扑修复（2025-11-06）

### 问题1：标准模式两行标签不生效
- 症状：节点名称包含 `<br/>` 时不换行，直接显示字面量。
- 根因：`vis-network` 多行标签需使用 `\n` 作为换行符，HTML `<br/>` 不会在 label 渲染中被解析。
- 方案：在 `static/js/topology_device.js` 中，`formatTwoLineLabel` 统一将断行替换为 `\n`，并在 `toVisData()` 生成节点时应用。
- 验收：设备级标准模式下所有超长标签按两行显示，无控制台报错。

### 问题2：总线模式拖拽单节点导致整图移动、布局失真
- 症状：拖动任一节点时，整体视图/其他节点跟随移动；初始布局呈“星形”。
- 根因：先启用层级 + 物理稳定化，再关闭会造成坐标不确定；交互配置未明确仅拖节点，且物理引擎残留导致整体漂移。
- 方案：实现 BFS 分层 + 栅格坐标 `applyBusGridLayout`，渲染后禁用 `hierarchical` 与 `physics`，开启 `interaction.dragNodes` 并禁用 `edges.smooth`，确保“拖节点不牵动整图”。
- 验收：设备级总线模式初始为自左向右分层栅格；拖拽单个节点时其余节点不动，视图不随动。

### 关联文件
- 前端：`static/js/topology_device.js`（`applyBusGridLayout`、`formatTwoLineLabel`、总线模式配置分支）。

### 回退策略
- 临时观察层级自动布局：将总线模式恢复 `hierarchical.enabled=true` 与 `physics.enabled=true`，定位拥挤后再关闭；严禁在运营态保留物理引擎。

### 经验教训
- UI 文本渲染要使用组件库原生支持的格式（本例为 `\n`），避免 HTML 期望与实际渲染不一致。
- 对运营态拓扑应优先采用确定性坐标与关闭物理引擎，交互上只允许拖节点而非拖视图。