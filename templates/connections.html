<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>连接管理 - 安吉电信动力设备管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/nav.css" rel="stylesheet">
    <style>
        .connection-type-ac {
            background-color: #e3f2fd;
            color: #0d47a1;
        }
        .connection-type-dc {
            background-color: #fff3e0;
            color: #e65100;
        }
        .connection-type-idle {
            background-color: #f5f5f5;
            color: #757575;
        }
        .text-purple {
            color: #9c27b0 !important;
        }
        .status-badge {
            font-size: 0.8em;
            padding: 0.25em 0.5em;
            border-radius: 0.25rem;
        }
        .statistics-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .statistics-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            background-color: #f8f9fa;
        }
        .statistics-card:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .statistics-card.cable {
            border-left-color: #2196f3;
        }
        .statistics-card.busbar {
            border-left-color: #ff9800;
        }
        .statistics-card.bus {
            border-left-color: #9c27b0;
        }
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        
        /* 固定表头样式 */
        .table-responsive table {
            position: relative;
        }
        
        .table-responsive thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #4a69bd !important; /* 使用统一的蓝色背景 */
            border-bottom: 2px solid #dee2e6;
        }
        
        /* 确保表头固定样式优先级 */
        .table-responsive .table thead th {
            position: sticky !important;
            top: 0 !important;
            z-index: 10 !important;
            background-color: #4a69bd !important;
        }
        
        /* 表格样式 */
        .table {
            margin-bottom: 0;
            table-layout: fixed;
        }
        
        /* 表头样式 - 参考设备管理页面 */
        .table thead th {
            background-color: #4a69bd !important;
            color: #ffffff !important;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
            white-space: nowrap;
            position: relative;
            border-color: #4a69bd !important;
            padding: 12px 15px;
        }
        
        /* 表头分隔线 */
        thead th:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 20%;
            height: 60%;
            width: 1px;
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* 特定列的对齐方式和宽度优化 */
        th:nth-child(1), td:nth-child(1) { /* 连接ID - 压缩 */
            text-align: center;
            width: 60px;
        }
        th:nth-child(2), td:nth-child(2) { /* A端设备 */
            text-align: left;
            width: 150px;
        }
        th:nth-child(3), td:nth-child(3) { /* A端端口 - 加宽 */
            text-align: center;
            width: 140px;
        }
        th:nth-child(4), td:nth-child(4) { /* A端额定电流 - 压缩 */
            text-align: right;
            font-family: 'Courier New', monospace;
            width: 90px;
        }
        th:nth-child(5), td:nth-child(5) { /* B端设备 */
            text-align: left;
            width: 150px;
        }
        th:nth-child(6), td:nth-child(6) { /* B端端口 - 加宽 */
            text-align: center;
            width: 140px;
        }
        th:nth-child(7), td:nth-child(7) { /* B端额定电流 - 压缩 */
            text-align: right;
            font-family: 'Courier New', monospace;
            width: 90px;
        }
        th:nth-child(8), td:nth-child(8) { /* 连接类型 */
            text-align: center;
            width: 100px;
        }
        th:nth-child(9), td:nth-child(9) { /* 规格型号 */
            text-align: left;
            width: 120px;
        }
        th:nth-child(10), td:nth-child(10) { /* 备注 - 加宽 */
            text-align: left;
            width: 140px;
        }
        th:nth-child(11), td:nth-child(11) { /* 操作 - 进一步压缩 */
            text-align: center;
            width: 120px;
            min-width: 120px;
        }
        
        .table td {
            vertical-align: middle;
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }
        
        /* 数字列的特殊样式 */
        td:nth-child(4), td:nth-child(7) { /* 额定电流列 */
            font-weight: 500;
        }
        
        tbody tr:nth-of-type(even) {
            background-color: #e9ecef;
            color: #333333;
        }
        tbody tr:hover {
            background-color: #007bff;
            color: #ffffff;
        }
        
        /* 一键到顶部和底部按钮样式 */
        .scroll-buttons {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .scroll-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background-color: #007bff;
            color: white;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .scroll-btn:hover {
            background-color: #0056b3;
            transform: scale(1.1);
        }
        
        .scroll-btn:active {
            transform: scale(0.95);
        }
        .connection-diagram {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-clean">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
            <i class="fas fa-project-diagram"></i> 安吉电信动力设备管理系统
            <span style="font-size: 0.8rem; color: #6c757d; margin-left: 10px;">Version 251019 | Email: 7843077@qq.com | WeChat: 7843077</span>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">设备管理</a>
                <a class="nav-link active" href="/connections">连接管理</a>
                <a class="nav-link" href="/analytics">统计分析</a>
                <a class="nav-link" href="/lifecycle-management">生命周期管理</a>
                <a class="nav-link" href="/topology">拓扑图</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row d-none">
            <div class="col-12">
                <h2><i class="fas fa-project-diagram"></i> 设备连接管理</h2>
                <p class="text-muted">管理设备间的供电连接关系</p>
            </div>
        </div>

        <!-- 统计信息卡片 -->
        <div class="row mb-4" id="statisticsCards">
            <!-- 统计卡片将通过JavaScript动态生成 -->
        </div>

        <!-- 标签页导航 -->
        <ul class="nav nav-tabs d-none" id="connectionTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab">
                    <i class="fas fa-list"></i> 连接列表
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link d-none" id="topology-tab" data-bs-toggle="tab" data-bs-target="#topology" type="button" role="tab">
                    <i class="fas fa-sitemap"></i> 拓扑图
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link d-none" id="statistics-tab" data-bs-toggle="tab" data-bs-target="#statistics" type="button" role="tab">
                    <i class="fas fa-chart-bar"></i> 连接统计
                </button>
            </li>

        </ul>

        <div class="tab-content" id="connectionTabsContent">
            <!-- 连接列表标签页 -->
            <div class="tab-pane fade show active" id="list" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list"></i> 连接关系列表</h5>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="exportConnections()" title="导出当前筛选结果为CSV">
                                <i class="fas fa-download"></i> 数据导出
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="showAddConnectionModal()">
                                <i class="fas fa-plus"></i> 添加连接
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 筛选条件 -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="connectionTypeFilter" class="form-label">连接类型：</label>
                            <select class="form-select" id="connectionTypeFilter" onchange="filterConnections()">
                                <option value="all">全部类型</option>
                                <option value="交流">交流</option>
                                <option value="直流">直流</option>
                                    <option value="已使用总量">已使用总量</option>
                                    <option value="空闲">空闲</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="deviceNameFilter" class="form-label">设备名称：</label>
                                <input type="text" class="form-control" id="deviceNameFilter" placeholder="输入设备名称（查找该设备的所有连接关系）" onblur="loadConnections()" onkeypress="if(event.key==='Enter') loadConnections()">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-outline-success me-2" onclick="loadConnections()">
                                    <i class="fas fa-sync-alt"></i> 刷新
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> 清除
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="connectionsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>连接ID</th>
                                        <th>A端设备</th>
                                        <th>A端端口</th>
                                        <th>A端额定电流</th>
                                        <th>B端设备</th>
                                        <th>B端端口</th>
                                        <th>B端额定电流</th>
                                        <th>连接类型</th>
                                        <th>规格型号</th>
                                        <th>备注</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 连接数据将通过JavaScript动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 拓扑图标签页 -->
            <div class="tab-pane fade d-none" id="topology" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-sitemap"></i> 连接拓扑图</h5>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="topologyFilter" class="form-label">显示设备：</label>
                                <select class="form-select" id="topologyFilter" onchange="loadTopology()">
                                    <option value="all">全部设备</option>
                                    <option value="ups">UPS设备</option>
                                    <option value="battery">电池组</option>
                                    <option value="distribution">配电设备</option>
                                </select>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button class="btn btn-outline-primary" onclick="loadTopology()">
                                    <i class="fas fa-sync-alt"></i> 刷新图表
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="topologyContainer" class="connection-diagram" style="height: 500px;">
                            <p class="text-muted">拓扑图加载中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 连接统计标签页 -->
            <div class="tab-pane fade d-none" id="statistics" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> 连接统计分析</h5>
                        <div>
                            <button class="btn btn-outline-info btn-sm me-2" onclick="showCapacityDistribution()" title="查看容量等级分布图表">
                                <i class="fas fa-chart-bar"></i> 容量等级分布
                            </button>
                            <button class="btn btn-outline-warning btn-sm me-2" onclick="showCapacityDetails()" title="查看容量统计详情表格">
                                <i class="fas fa-table"></i> 统计详情
                            </button>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshConnectionStatistics()">
                                <i class="fas fa-sync-alt"></i> 刷新
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="exportConnectionStatistics()">
                                <i class="fas fa-download"></i> 导出
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 连接统计图表 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <canvas id="connectionTypeChart" width="400" height="200"></canvas>
                            </div>
                            <div class="col-md-6">
                                <canvas id="deviceConnectionChart" width="400" height="200"></canvas>
                            </div>
                        </div>

                        <!-- 容量分布统计图表 - 默认隐藏 -->
                        <div class="row mb-4" id="capacityDistributionSection" style="display: none;">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-chart-bar"></i> 容量等级分布</h6>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="hideCapacityDistribution()">
                                            <i class="fas fa-times"></i> 关闭
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="capacityChart" width="400" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 容量统计表格 - 默认隐藏 -->
                        <div class="row mb-4" id="capacityDetailsSection" style="display: none;">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-table"></i> 容量统计详情</h6>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="hideCapacityDetails()">
                                            <i class="fas fa-times"></i> 关闭
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover" id="capacityStatsTable">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>容量等级</th>
                                                        <th>熔丝端口数</th>
                                                        <th>空开端口数</th>
                                                        <th>总端口数</th>
                                                        <th>已使用端口</th>
                                                        <th>空闲端口</th>
                                                        <th>使用率</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- 容量统计数据将通过JavaScript动态加载 -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- 一键到顶部和底部按钮 -->
    <div class="scroll-buttons">
        <button class="scroll-btn" onclick="scrollToTop()" title="回到顶部">
            <i class="fas fa-chevron-up"></i>
        </button>
        <button class="scroll-btn" onclick="scrollToBottom()" title="到达底部">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>

    <!-- 添加/编辑连接模态框 -->
    <div class="modal fade" id="connectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="connectionModalTitle">添加连接关系</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="connectionForm">
                    <div class="modal-body">
                        <input type="hidden" id="connectionId" name="connectionId">
                        
                        <!-- A端设备信息 -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary"><i class="fas fa-plug"></i> A端设备信息</h6>
                            </div>
                            <div class="col-md-6">
                                <label for="deviceAId" class="form-label">A端设备 <span class="text-danger">*</span></label>
                                <select class="form-select" id="deviceAId" name="source_device_id" required>
                                    <option value="">请选择设备</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="portA" class="form-label">A端端口</label>
                                <input type="text" class="form-control" id="portA" name="source_port" placeholder="如：输出端口1">
                            </div>
                        </div>

                        <!-- B端设备信息 -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary"><i class="fas fa-plug"></i> B端设备信息</h6>
                            </div>
                            <div class="col-md-6">
                                <label for="deviceBId" class="form-label">B端设备 <span class="text-danger">*</span></label>
                                <select class="form-select" id="deviceBId" name="target_device_id" required>
                                    <option value="">请选择设备</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="portB" class="form-label">B端端口</label>
                                <input type="text" class="form-control" id="portB" name="target_port" placeholder="如：输入端口1">
                            </div>
                        </div>

                        <!-- 连接信息 -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary"><i class="fas fa-link"></i> 连接信息</h6>
                            </div>
                            <div class="col-md-4">
                                <label for="connectionType" class="form-label">连接类型 <span class="text-danger">*</span></label>
                        <select class="form-select" id="connectionType" name="connection_type" required onchange="toggleSpecificationFields()">
                            <option value="">请选择连接类型</option>
                            <option value="交流">交流</option>
                            <option value="直流">直流</option>
                                    <option value="空闲">空闲</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="parallelCount" class="form-label">并联数量</label>
                                <input type="number" class="form-control" id="parallelCount" name="parallel_count" min="1" value="1">
                            </div>
                            <div class="col-md-4">
                                <label for="ratedCurrent" class="form-label">额定电流(A)</label>
                                <input type="number" class="form-control" id="ratedCurrent" name="rated_current" step="0.1">
                            </div>
                        </div>

                        <!-- 技术参数 -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary"><i class="fas fa-cog"></i> 技术参数</h6>
                            </div>
                            <div class="col-md-6" id="cableSpecGroup" style="display: none;">
                                <label for="cableSpecification" class="form-label">电缆规格</label>
                                <input type="text" class="form-control" id="cableSpecification" name="cable_model" placeholder="如：YJV-4×120+1×70">
                            </div>
                            <div class="col-md-6" id="busbarSpecGroup" style="display: none;">
                                <label for="busbarSpecification" class="form-label">铜排规格</label>
                                <input type="text" class="form-control" id="busbarSpecification" name="cable_model" placeholder="如：TMY-100×10">
                            </div>
                            <div class="col-md-6">
                                <label for="length" class="form-label">长度(m)</label>
                                <input type="number" class="form-control" id="length" name="cable_length" step="0.1">
                            </div>
                        </div>

                        <!-- 附加信息 -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary"><i class="fas fa-info-circle"></i> 附加信息</h6>
                            </div>
                            <div class="col-md-6">
                                <label for="installationDate" class="form-label">安装日期</label>
                                <input type="text" class="form-control" id="installationDate" name="installation_date" placeholder="请输入YYYYMM格式，如：202412" pattern="[0-9]{6}" maxlength="6">
                            </div>
                            <div class="col-md-6">
                                <label for="adminPassword" class="form-label">管理员密码 <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="adminPassword" name="password" required placeholder="请输入管理员密码">
                            </div>
                            <div class="col-12 mt-2">
                                <label for="notes" class="form-label">备注</label>
                                <textarea class="form-control" id="notes" name="remark" rows="2" placeholder="连接相关的备注信息"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadConnections();
            loadDeviceOptions();
        });

        // 加载统计信息
        async function loadStatistics() {
            try {
                const response = await fetch('/api/connections/statistics');
                if (response.ok) {
                    const stats = await response.json();
                    displayStatistics(stats);
                }
            } catch (error) {
                console.error('加载统计信息失败:', error);
            }
        }

        // 显示统计信息卡片
        function displayStatistics(stats) {
            // API返回的数据在stats.data中
            const data = stats.data || stats;
            const container = document.getElementById('statisticsCards');
            container.innerHTML = `
                <div class="col-md-2 col-sm-6 mb-3">
                    <div class="card statistics-card clickable-card" onclick="showDeviceList()" style="cursor: pointer;" title="点击查看设备列表">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-server fa-2x text-primary"></i>
                            </div>
                            <h3 class="text-primary mb-1">${data.total_devices || 0}</h3>
                            <h6 class="card-title text-muted mb-0">设备总数</h6>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-sm-6 mb-3">
                    <div class="card statistics-card clickable-card" onclick="showPortStatistics()" style="cursor: pointer;" title="点击查看所有连接">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-plug fa-2x text-success"></i>
                            </div>
                            <h3 class="text-success mb-1">${data.total_ports || 0}</h3>
                            <h6 class="card-title text-muted mb-0">端口总数</h6>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-sm-6 mb-3">
                    <div class="card statistics-card clickable-card" onclick="filterByConnectionType('已使用总量')" style="cursor: pointer;" title="点击查看已使用总量">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-link fa-2x text-warning"></i>
                            </div>
                            <h3 class="text-warning mb-1">${data.connected_ports || 0}</h3>
                            <h6 class="card-title text-muted mb-0">已使用端口</h6>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-sm-6 mb-3">
                    <div class="card statistics-card clickable-card" onclick="filterByPortStatus('idle')" style="cursor: pointer;" title="点击查看空闲端口">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-circle fa-2x text-info"></i>
                            </div>
                            <h3 class="text-info mb-1">${data.idle_ports || 0}</h3>
                            <h6 class="card-title text-muted mb-0">空闲端口</h6>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-sm-6 mb-3">
                    <div class="card statistics-card clickable-card" onclick="filterByConnectionType('已使用总量')" style="cursor: pointer;" title="点击查看已使用连接">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-project-diagram fa-2x text-purple"></i>
                            </div>
                            <h3 class="text-purple mb-1">${data.total_connections || 0}</h3>
                            <h6 class="card-title text-muted mb-0">连接数量</h6>
                        </div>
                    </div>
            `;
        }

        // 统计卡片导航功能
        function showDeviceList() {
            // 跳转到设备列表页面
            window.location.href = '/';
        }

        function showPortStatistics() {
            // 显示所有端口相关的连接（包括已使用和空闲端口）
            filterByConnectionType('all');
        }

        function filterByPortStatus(status) {
            // 切换到连接列表标签页并筛选对应状态的端口
            const listTab = document.getElementById('list-tab');
            if (listTab) {
                const tab = new bootstrap.Tab(listTab);
                tab.show();
                
                // 根据端口状态筛选连接
                setTimeout(() => {
                    if (status === 'connected') {
                        // 筛选已使用端口 - 显示所有有连接的记录
                        document.getElementById('connectionTypeFilter').value = 'all';
                        loadConnections();
                        console.log('筛选已使用端口');
                    } else if (status === 'idle') {
                        // 筛选空闲端口 - 显示连接类型为空的记录
                        document.getElementById('connectionTypeFilter').value = '空闲';
                        loadConnections();
                        console.log('筛选空闲端口');
                    }
                }, 100);
             }
         }

         // 获取数据库中对应的连接类型值（支持中英文混合查询）
        function getDatabaseConnectionTypes(displayType) {
            const typeMap = {
                '交流': ['AC', 'ac', '交流'],
                '直流': ['DC', 'dc', '直流'],
                '已使用总量': 'used_total', // 特殊标识，表示所有非空连接
                '空闲': [null, '', 'null', 'None', 'nan', 'NaN', undefined]
            };
            return typeMap[displayType] || [displayType];
        }

        // 加载连接列表
        async function loadConnections() {
            try {
                const typeFilter = document.getElementById('connectionTypeFilter').value;
                const deviceNameFilter = document.getElementById('deviceNameFilter').value;
                
                let url = '/api/connections?page_size=100'; // 增加页面大小以获取更多数据
                const params = new URLSearchParams();
                
                // 如果有类型筛选，我们需要在前端进行筛选，因为数据库中有混合的中英文值
                if (deviceNameFilter) params.append('device_name', deviceNameFilter);
                
                if (params.toString()) {
                    url += '&' + params.toString();
                }
                
                const response = await fetch(url);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        let filteredData = result.data;
                        
                        // 在前端进行连接类型筛选
                        if (typeFilter !== 'all') {
                            const allowedTypes = getDatabaseConnectionTypes(typeFilter);
                            
                            if (allowedTypes === 'used_total') {
                                // 筛选已使用总量：排除空值（含 'nan'/'None' 等）
                                filteredData = result.data.filter(conn => !isEmptyValue(conn.connection_type));
                            } else if (typeFilter === '空闲') {
                                // 空闲端口：包含所有空值（含 'nan'/'None' 等）
                                filteredData = result.data.filter(conn => isEmptyValue(conn.connection_type));
                            } else {
                                // 其他类型的正常筛选（交流/直流等）
                                filteredData = result.data.filter(conn => 
                                    allowedTypes.includes(conn.connection_type)
                                );
                            }
                        }
                        
                        displayConnections(filteredData);
                        updatePagination(result.pagination);
                    } else {
                        console.error('API返回格式错误:', result);
                    }
                }
            } catch (error) {
                console.error('加载连接列表失败:', error);
            }
        }

        // 工具函数：判断空值（含 'nan'/'null'/'None'）
        function isEmptyValue(val) {
            if (val === undefined || val === null) return true;
            const s = String(val).trim().toLowerCase();
            return s === '' || s === 'null' || s === 'none' || s === 'nan';
        }

        // 工具函数：展示前清洗值（空值统一为 '-')
        function sanitizeValue(val) {
            if (val === undefined || val === null) return '-';
            const s = String(val).trim();
            const lower = s.toLowerCase();
            if (s === '' || lower === 'null' || lower === 'none' || lower === 'nan') return '-';
            return s;
        }

        // 连接类型映射函数
        function getConnectionTypeDisplay(type) {
            // 空值（含 'nan'）视为空闲
            if (isEmptyValue(type)) {
                return '空闲';
            }
            
            const typeMap = {
                'AC': '交流',
                'ac': '交流',
                'DC': '直流',
                'dc': '直流',
                '交流': '交流',
                '直流': '直流',
                '空闲': '空闲'
            };
            return typeMap[type] || type;
        }

        // 从规格字符串中提取额定电流（阿拉伯数字）
        function extractRatingFromSpec(spec) {
            if (!spec) return '-';
            
            // 使用正则表达式提取数字（支持整数和小数）
            const match = spec.match(/\d+(\.\d+)?/);
            if (match) {
                return match[0] + 'A';
            }
            return '-';
        }

        // 显示连接列表
        function displayConnections(connections) {
            const tbody = document.querySelector('#connectionsTable tbody');
            tbody.innerHTML = '';
            
            connections.forEach(conn => {
                const displayType = getConnectionTypeDisplay(conn.connection_type);
                // 修复连接类型CSS类名映射
                const typeClassMap = {
                    '交流': 'ac',
                    '直流': 'dc', 
                    '空闲': 'idle',
                    'AC': 'ac',
                    'ac': 'ac',
                    'DC': 'dc',
                    'dc': 'dc'
                };
                // 如果连接类型为空（含 'nan'），使用空闲样式
                const typeClass = typeClassMap[displayType] || (isEmptyValue(conn.connection_type) ? 'idle' : 'unknown');
                
                const row = document.createElement('tr');
                // 处理备注显示，如果备注过长则截断并添加省略号
                const remarkText = sanitizeValue(conn.remark);
                const displayRemark = remarkText !== '-' && remarkText.length > 20 ? remarkText.substring(0, 20) + '...' : remarkText;
                
                // 使用清洗后的 A/B 端额定电流字段
                const sourceRating = sanitizeValue(conn.a_rated_current);
                const targetRating = sanitizeValue(conn.b_rated_current);
                
                row.innerHTML = `
                    <td>${conn.id}</td>
                    <td>${sanitizeValue(conn.source_device_name) || 'N/A'}</td>
                    <td>${sanitizeValue(conn.source_port)}</td>
                    <td>${sourceRating}</td>
                    <td>${sanitizeValue(conn.target_device_name) || 'N/A'}</td>
                    <td>${sanitizeValue(conn.target_port)}</td>
                    <td>${targetRating}</td>
                    <td><span class="badge status-badge connection-type-${typeClass}">${displayType}</span></td>
                    <td>${sanitizeValue(conn.cable_model)}</td>
                    <td title="${remarkText}">${displayRemark}</td>
                    <td>
                        <div class="d-flex gap-1 flex-wrap justify-content-center">
                            <button class="btn btn-warning btn-sm text-dark" onclick="editConnection(${conn.id})" title="编辑连接">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-danger btn-sm text-white" onclick="deleteConnection(${conn.id})" title="删除连接">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 加载设备选项
        async function loadDeviceOptions() {
            try {
                // 首先获取第一页数据以了解总页数
                const firstResponse = await fetch('/api/devices?page=1');
                if (!firstResponse.ok) {
                    throw new Error('获取设备数据失败');
                }
                
                const firstResult = await firstResponse.json();
                const totalPages = firstResult.pagination ? firstResult.pagination.total_pages : 1;
                
                let allDevices = [];
                
                // 加载所有页面的设备数据
                for (let page = 1; page <= totalPages; page++) {
                    const response = await fetch(`/api/devices?page=${page}`);
                    if (response.ok) {
                        const result = await response.json();
                        const devices = result.success && result.data ? result.data : result;
                        allDevices = allDevices.concat(devices);
                    }
                }
                
                const deviceASelect = document.getElementById('deviceAId');
                const deviceBSelect = document.getElementById('deviceBId');
                
                // 清空现有选项，保留默认的"请选择设备"选项
                deviceASelect.innerHTML = '<option value="">请选择设备</option>';
                deviceBSelect.innerHTML = '<option value="">请选择设备</option>';
                
                // 添加所有设备选项
                allDevices.forEach(device => {
                    const optionA = new Option(`${device.asset_id} - ${device.name}`, device.id);
                    const optionB = new Option(`${device.asset_id} - ${device.name}`, device.id);
                    deviceASelect.add(optionA);
                    deviceBSelect.add(optionB);
                });
                
                console.log(`已加载 ${allDevices.length} 个设备选项`);
                
                // 为设备选择器添加change事件监听
                deviceASelect.addEventListener('change', function() {
                    loadDevicePorts(this.value, 'portA');
                });
                
                deviceBSelect.addEventListener('change', function() {
                    loadDevicePorts(this.value, 'portB');
                });
                
            } catch (error) {
                console.error('加载设备选项失败:', error);
            }
        }
        
        // 加载设备端口选项
        async function loadDevicePorts(deviceId, portInputId) {
            const portInput = document.getElementById(portInputId);
            
            if (!deviceId) {
                // 如果没有选择设备，恢复为普通文本输入框
                portInput.type = 'text';
                portInput.innerHTML = '';
                portInput.placeholder = portInputId === 'portA' ? '如：输出端口1' : '如：输入端口1';
                return;
            }
            
            try {
                const response = await fetch(`/api/devices/${deviceId}/ports`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.ports) {
                    const ports = result.data.ports;
                    
                    if (ports.length > 0) {
                        // 将文本输入框转换为下拉选择框
                        const currentValue = portInput.value;
                        const parentElement = portInput.parentElement;
                        
                        // 创建新的select元素
                        const selectElement = document.createElement('select');
                        selectElement.className = portInput.className;
                        selectElement.id = portInput.id;
                        selectElement.name = portInput.name;
                        
                        // 添加默认选项
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = '请选择端口';
                        selectElement.appendChild(defaultOption);
                        
                        // 添加端口选项
                        ports.forEach(port => {
                            const option = document.createElement('option');
                            option.value = port.port_name;
                            option.textContent = `${port.port_name} (${port.specification || '未知规格'})`;
                            if (port.status === '已连接') {
                                option.textContent += ' - 已使用';
                                option.style.color = '#6c757d';
                            }
                            selectElement.appendChild(option);
                        });
                        
                        // 如果之前有值，尝试保持选中
                        if (currentValue) {
                            selectElement.value = currentValue;
                        }
                        
                        // 替换原来的input元素
                        parentElement.replaceChild(selectElement, portInput);
                        
                        console.log(`已加载设备 ${deviceId} 的 ${ports.length} 个端口选项`);
                    } else {
                        // 没有端口数据，保持文本输入框
                        portInput.placeholder = '该设备暂无端口数据，请手动输入';
                    }
                } else {
                    console.warn('获取设备端口失败:', result.message || '未知错误');
                    portInput.placeholder = '获取端口失败，请手动输入';
                }
            } catch (error) {
                console.error('加载设备端口失败:', error);
                portInput.placeholder = '加载端口失败，请手动输入';
            }
        }

        // 显示添加连接模态框
        function showAddConnectionModal() {
            document.getElementById('connectionModalTitle').textContent = '添加连接关系';
            document.getElementById('connectionForm').reset();
            document.getElementById('connectionId').value = '';
            new bootstrap.Modal(document.getElementById('connectionModal')).show();
        }

        // 密码验证对话框函数
        function showPasswordDialog(title, callback) {
            // 创建遮罩层
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;
            
            // 创建对话框
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                min-width: 300px;
                text-align: center;
            `;
            
            dialog.innerHTML = `
                <h3 style="margin-top: 0; color: #333;">${title}</h3>
                <p style="margin: 10px 0; color: #666; font-size: 14px; line-height: 1.4;">
                    为了保护系统安全，此操作需要管理员密码验证。<br>
                    请输入管理员密码以继续操作。
                </p>
                <input type="password" id="passwordInput" placeholder="请输入管理员密码" 
                       style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                <div style="margin-top: 15px;">
                    <button id="confirmBtn" style="background: #007bff; color: white; border: none; padding: 8px 16px; margin: 0 5px; border-radius: 4px; cursor: pointer;">确定</button>
                    <button id="cancelBtn" style="background: #6c757d; color: white; border: none; padding: 8px 16px; margin: 0 5px; border-radius: 4px; cursor: pointer;">取消</button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            const passwordInput = dialog.querySelector('#passwordInput');
            const confirmBtn = dialog.querySelector('#confirmBtn');
            const cancelBtn = dialog.querySelector('#cancelBtn');
            
            // 聚焦到密码输入框
            passwordInput.focus();
            
            // 处理确定按钮点击
            const handleConfirm = () => {
                const password = passwordInput.value;
                if (password.trim() === '') {
                    alert('密码不能为空');
                    passwordInput.focus();
                    return;
                }
                document.body.removeChild(overlay);
                callback(password);
            };
            
            // 处理取消按钮点击
            const handleCancel = () => {
                document.body.removeChild(overlay);
                callback(null);
            };
            
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            
            // 支持回车键确认
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleConfirm();
                }
            });
            
            // 支持ESC键取消
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    document.removeEventListener('keydown', escHandler);
                    handleCancel();
                }
            });
        }

        // 编辑连接
        async function editConnection(id) {
            showPasswordDialog('编辑连接关系', async (password) => {
                if (password === null) return; // 用户取消
                
                try {
                    // 首先确保设备选项已加载
                    await loadDeviceOptions();
                    
                    const response = await fetch(`/api/connections/${id}`);
                    if (response.ok) {
                        const result = await response.json();
                        const connection = result.data; // 解包API响应数据
                        
                        // 将数据库中的连接类型转换为表单中的中文显示值
                        const displayType = getConnectionTypeDisplay(connection.connection_type);
                        
                        document.getElementById('connectionModalTitle').textContent = '编辑连接关系';
                        document.getElementById('connectionId').value = connection.id;
                        
                        // 等待一小段时间确保DOM更新完成，然后设置设备选项的值
                        setTimeout(async () => {
                            document.getElementById('deviceAId').value = connection.source_device_id;
                            document.getElementById('deviceBId').value = connection.target_device_id;
                            console.log('设置A端设备ID:', connection.source_device_id);
                            console.log('设置B端设备ID:', connection.target_device_id);
                            
                            // 加载对应设备的端口选项
                            if (connection.source_device_id) {
                                await loadDevicePorts(connection.source_device_id, 'portA');
                            }
                            if (connection.target_device_id) {
                                await loadDevicePorts(connection.target_device_id, 'portB');
                            }
                            
                            // 等待端口加载完成后再设置端口值
                            setTimeout(() => {
                                const portAElement = document.getElementById('portA');
                                const portBElement = document.getElementById('portB');
                                
                                if (portAElement) {
                                    portAElement.value = connection.source_port || '';
                                }
                                if (portBElement) {
                                    portBElement.value = connection.target_port || '';
                                }
                            }, 200);
                        }, 100);
                        document.getElementById('connectionType').value = displayType;
                        document.getElementById('parallelCount').value = connection.parallel_count || 1;
                        document.getElementById('ratedCurrent').value = connection.rated_current || '';
                        document.getElementById('cableSpecification').value = connection.cable_model || '';
                        document.getElementById('busbarSpecification').value = connection.cable_model || '';
                        document.getElementById('length').value = connection.cable_length || '';
                        document.getElementById('installationDate').value = connection.installation_date ? connection.installation_date : '';
                        document.getElementById('adminPassword').value = password; // 设置密码
                        document.getElementById('notes').value = connection.remark || '';
                        
                        toggleSpecificationFields();
                        new bootstrap.Modal(document.getElementById('connectionModal')).show();
                    } else {
                        alert('加载连接信息失败');
                    }
                } catch (error) {
                    console.error('加载连接信息失败:', error);
                    alert('加载连接信息失败：' + error.message);
                }
            });
        }

        // 删除连接
        async function deleteConnection(id) {
            if (!confirm('确定要删除这个连接关系吗？此操作不可撤销！')) {
                return;
            }
            
            showPasswordDialog('删除连接关系', async (password) => {
                if (password === null) return; // 用户取消
                
                try {
                    const formData = new FormData();
                    formData.append('password', password);
                    
                    const response = await fetch(`/api/connections/${id}`, {
                        method: 'DELETE',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        alert('连接删除成功');
                        
                        // 删除成功后才清除筛选条件并重新加载全部连接列表
                        document.getElementById('deviceNameFilter').value = '';
                        document.getElementById('connectionTypeFilter').value = 'all';
                        
                        // 重新加载连接列表和统计数据
                        loadConnections();
                        loadStatistics();
                    } else {
                        const error = await response.json();
                        alert(error.detail || '删除失败');
                    }
                } catch (error) {
                    console.error('删除连接失败:', error);
                    alert('删除失败：' + error.message);
                }
            });
        }

        // 切换规格字段显示
        function toggleSpecificationFields() {
            const connectionType = document.getElementById('connectionType').value;
            const cableGroup = document.getElementById('cableSpecGroup');
            const busbarGroup = document.getElementById('busbarSpecGroup');
            
            // 根据新的连接类型规则，交流和直流都可能需要不同的规格字段
            // 这里暂时隐藏所有规格字段，因为连接类型已改为交流/直流
            cableGroup.style.display = 'none';
            busbarGroup.style.display = 'none';
        }

        function formatErrorMessage(error) {
            if (typeof error === 'string') {
                return error;
            }
            if (error && error.message) { // For JS Error objects
                return error.message;
            }
            if (error && error.detail) { // For FastAPI HTTPExceptions
                if (typeof error.detail === 'string') {
                    return error.detail;
                }
                // Handle FastAPI validation errors which have detail as an array of objects
                if (Array.isArray(error.detail)) {
                    return error.detail.map(d => `${d.loc.join(' -> ')}: ${d.msg}`).join('\n');
                }
                return JSON.stringify(error.detail, null, 2);
            }
            return JSON.stringify(error, null, 2); // Fallback
        }

        // 清除筛选条件
        function clearFilters() {
            document.getElementById('connectionTypeFilter').value = 'all';
            document.getElementById('deviceNameFilter').value = '';
            loadConnections();
        }

        // 表单提交处理
        document.getElementById('connectionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('表单提交事件触发');
            
            const originalFormData = new FormData(this);

            // 清理可选的空数字字段，防止后端验证错误
            // 如果字段为空字符串，从FormData中删除，这样后端会收到None
            if (originalFormData.get('parallel_count') === '') {
                originalFormData.delete('parallel_count');
            }
            if (originalFormData.get('rated_current') === '') {
                originalFormData.delete('rated_current');
            }
            if (originalFormData.get('cable_length') === '') {
                originalFormData.delete('cable_length');
            }

            const data = Object.fromEntries(originalFormData.entries());
            console.log('清理后的表单数据:', data);
            
            const isEdit = data.connectionId;
            const url = isEdit ? `/api/connections/${data.connectionId}` : '/api/connections';
            const method = isEdit ? 'PUT' : 'POST';
            console.log('请求URL:', url, '方法:', method, '是否编辑:', isEdit);
            
            try {
                let requestBody, headers;
                if (method === 'POST') {
                    if (originalFormData.has('connectionId')) {
                        originalFormData.delete('connectionId');
                    }
                    requestBody = originalFormData;
                    headers = {};
                } else {
                    originalFormData.delete('connectionId');
                    requestBody = originalFormData;
                    headers = {};
                }
                
                console.log('发送请求:', { url, method, headers, body: requestBody });
                const response = await fetch(url, {
                    method: method,
                    headers: headers,
                    body: requestBody
                });
                
                console.log('响应状态:', response.status, response.statusText);
                if (response.ok) {
                    const result = await response.json();
                    console.log('保存成功响应:', result);
                    
                    alert('保存成功！');
                    
                    // 保存成功后才隐藏模态框
                    bootstrap.Modal.getInstance(document.getElementById('connectionModal')).hide();
                    
                    // 清除筛选条件并重新加载全部连接列表
                    document.getElementById('deviceNameFilter').value = '';
                    document.getElementById('connectionTypeFilter').value = 'all';
                    
                    // 重新加载连接列表和统计数据
                    loadConnections();
                    loadStatistics();
                } else {
                    const error = await response.json().catch(() => response.text());
                    console.log('保存失败响应:', error);
                    alert('保存失败: ' + formatErrorMessage(error));
                }
            } catch (error) {
                console.error('保存连接失败:', error);
                alert('保存连接时发生预料之外的错误: ' + formatErrorMessage(error));
            }
        });

        // 更新分页信息
        function updatePagination(pagination) {
            // 这里可以添加分页控件的更新逻辑
            // 目前暂时不实现分页UI，只是为了避免JavaScript错误
            console.log('分页信息:', pagination);
        }

        // 更新单个连接行（避免重新加载整个列表）
        async function updateConnectionRow(connectionId) {
            try {
                // 获取更新后的连接数据
                const response = await fetch(`/api/connections/${connectionId}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const conn = result.data;
                        
                        // 查找对应的表格行
                        const tbody = document.querySelector('#connectionsTable tbody');
                        const rows = tbody.querySelectorAll('tr');
                        
                        for (let row of rows) {
                            const firstCell = row.querySelector('td:first-child');
                            if (firstCell && firstCell.textContent == connectionId) {
                                // 更新这一行的数据
                                const displayType = getConnectionTypeDisplay(conn.connection_type);
                                const typeClassMap = {
                                    '交流': 'ac',
                                    '直流': 'dc', 
                                    '空闲': 'idle',
                                    'AC': 'ac',
                                    'ac': 'ac',
                                    'DC': 'dc',
                                    'dc': 'dc'
                                };
                                const typeClass = typeClassMap[displayType] || ((!conn.connection_type || conn.connection_type === 'null' || conn.connection_type === 'None') ? 'idle' : 'unknown');
                                
                                const remarkText = conn.remark || '-';
                                const displayRemark = remarkText.length > 20 ? remarkText.substring(0, 20) + '...' : remarkText;
                                const sourceRating = conn.a_rated_current || '-';
                                const targetRating = conn.b_rated_current || '-';
                                
                                row.innerHTML = `
                                    <td>${conn.id}</td>
                                    <td>${conn.source_device_name || 'N/A'}</td>
                                    <td>${conn.source_port || '-'}</td>
                                    <td>${sourceRating}</td>
                                    <td>${conn.target_device_name || 'N/A'}</td>
                                    <td>${conn.target_port || '-'}</td>
                                    <td>${targetRating}</td>
                                    <td><span class="badge status-badge connection-type-${typeClass}">${displayType}</span></td>
                                    <td>${conn.cable_model || '-'}</td>
                                    <td title="${remarkText}">${displayRemark}</td>
                                    <td>
                                        <div class="d-flex gap-1 flex-wrap justify-content-center">
                                            <button class="btn btn-warning btn-sm text-dark" onclick="editConnection(${conn.id})" title="编辑连接">
                                                <i class="fas fa-edit"></i> 编辑
                                            </button>
                                            <button class="btn btn-danger btn-sm text-white" onclick="deleteConnection(${conn.id})" title="删除连接">
                                                <i class="fas fa-trash"></i> 删除
                                            </button>
                                        </div>
                                    </td>
                                `;
                                break;
                            }
                        }
                    }
                } else {
                    console.error('获取连接数据失败:', response.status);
                    // 如果获取单个连接失败，回退到重新加载整个列表
                    loadConnections();
                }
            } catch (error) {
                console.error('更新连接行失败:', error);
                // 如果更新失败，回退到重新加载整个列表
                loadConnections();
            }
        }

        // 加载拓扑图（占位符功能）
        function loadTopology() {
            const container = document.getElementById('topologyContainer');
            container.innerHTML = '<p class="text-muted">拓扑图功能开发中，敬请期待...</p>';
        }

        // 滚动到顶部
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // 滚动到底部
        function scrollToBottom() {
            // 首先滚动到页面底部
            window.scrollTo({
                top: Math.max(document.body.scrollHeight, document.documentElement.scrollHeight),
                behavior: 'smooth'
            });
            
            // 然后滚动表格容器到底部
            setTimeout(() => {
                const tableContainer = document.querySelector('.table-responsive');
                if (tableContainer) {
                    tableContainer.scrollTo({
                        top: tableContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }, 300); // 延迟300ms确保页面滚动完成
        }

        // 端口统计管理类
        class PortStatisticsManager {
            constructor() {
                this.capacityChart = null;
                this.isDataLoaded = false; // 跟踪数据是否已加载
            }

            // 加载端口统计数据
            async loadPortStatistics() {
                try {
                    const response = await fetch('/api/ports/statistics');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.renderPortStatistics(result.data);
                        } else {
                            console.error('获取端口统计失败:', result.message);
                        }
                    } else {
                        console.error('API请求失败:', response.status);
                    }
                } catch (error) {
                    console.error('加载端口统计失败:', error);
                }
            }

            // 渲染端口统计数据
            renderPortStatistics(data) {
                this.updateOverviewCards(data.device_port_summary);
                this.renderCapacityChart(data.capacity_statistics);
                this.updateCapacityTable(data.capacity_statistics);
                this.updateDevicePortsTable(data.device_port_details);
                this.isDataLoaded = true; // 标记数据已加载
            }

            // 更新概览卡片
            updateOverviewCards(summary) {
                const container = document.getElementById('portOverviewCards');
                container.innerHTML = `
                    <div class="col-md-3">
                        <div class="card statistics-card">
                            <div class="card-body text-center">
                                <h3 class="text-primary">${summary.total_devices}</h3>
                                <p class="mb-0">设备总数</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card statistics-card">
                            <div class="card-body text-center">
                                <h3 class="text-success">${summary.total_ports}</h3>
                                <p class="mb-0">端口总数</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card statistics-card">
                            <div class="card-body text-center">
                                <h3 class="text-warning">${summary.connected_ports}</h3>
                                <p class="mb-0">已使用端口</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card statistics-card">
                            <div class="card-body text-center">
                                <h3 class="text-info">${summary.idle_ports}</h3>
                                <p class="mb-0">空闲端口</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 渲染容量分布图表
            renderCapacityChart(capacityStats) {
                const ctx = document.getElementById('capacityChart').getContext('2d');
                
                if (this.capacityChart) {
                    this.capacityChart.destroy();
                }

                const labels = Object.keys(capacityStats);
                const totalPorts = labels.map(label => capacityStats[label].total_ports);
                const usedPorts = labels.map(label => capacityStats[label].used_ports);

                this.capacityChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '总端口数',
                                data: totalPorts,
                                backgroundColor: '#36a2eb',
                                borderWidth: 1
                            },
                            {
                                label: '已使用端口',
                                data: usedPorts,
                                backgroundColor: '#ff6384',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
            }

            // 更新容量统计表格
            updateCapacityTable(capacityStats) {
                const tbody = document.querySelector('#capacityStatsTable tbody');
                tbody.innerHTML = '';

                Object.keys(capacityStats).forEach(capacity => {
                    const stats = capacityStats[capacity];
                    const utilizationRate = stats.total_ports > 0 ? 
                        ((stats.connected_ports / stats.total_ports) * 100).toFixed(1) : '0.0';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${capacity}</td>
                        <td>${stats.fuse_ports}</td>
                        <td>${stats.breaker_ports}</td>
                        <td>${stats.total_ports}</td>
                        <td>${stats.connected_ports}</td>
                        <td>${stats.idle_ports}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${utilizationRate}%" 
                                         aria-valuenow="${utilizationRate}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <span class="text-nowrap">${utilizationRate}%</span>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // 更新设备端口详情表格
            updateDevicePortsTable(deviceDetails) {
                const tbody = document.querySelector('#devicePortsTable tbody');
                tbody.innerHTML = '';

                deviceDetails.forEach(device => {
                    const utilizationRate = device.total_ports > 0 ? 
                        ((device.connected_ports / device.total_ports) * 100).toFixed(1) : '0.0';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${device.device_name}</td>
                        <td>${device.device_type || '-'}</td>
                        <td>${device.fuse_ports}</td>
                        <td>${device.breaker_ports}</td>
                        <td>${device.total_ports}</td>
                        <td>${device.connected_ports}</td>
                        <td>${device.idle_ports}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${utilizationRate}%" 
                                         aria-valuenow="${utilizationRate}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <span class="text-nowrap">${utilizationRate}%</span>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-info btn-sm" 
                                    onclick="viewDevicePortDetails(${device.device_id})" 
                                    title="查看详情">
                                <i class="fas fa-eye"></i> 详情
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // 创建端口统计管理器实例
        const portStatsManager = new PortStatisticsManager();

        // 刷新端口统计
        function refreshPortStatistics() {
            portStatsManager.loadPortStatistics();
        }

        // 导出端口统计
        function exportPortStatistics() {
            // 这里可以实现导出功能
            alert('导出功能开发中，敬请期待...');
        }

        // 根据连接类型筛选连接列表
        function filterByConnectionType(connectionType) {
            // 切换到连接列表标签页
            const connectionListTab = document.getElementById('list-tab');
            if (connectionListTab) {
                const tab = new bootstrap.Tab(connectionListTab);
                tab.show();
            }
            
            // 设置筛选条件
            const typeFilter = document.getElementById('connectionTypeFilter');
            if (typeFilter) {
                // 映射连接类型到筛选器值（支持中文输入）
                const typeMapping = {
                    '': 'all',           // 总连接数
                    'all': 'all',
                    '电缆': '电缆',
                    'cable': '电缆',
                    '铜排': '铜排',
                    'busbar': '铜排', 
                    '母线': '母线',
                    'bus': '母线',
                    '已使用总量': '已使用总量',  // 已使用端口总量
                    'used_total': '已使用总量'
                };
                typeFilter.value = typeMapping[connectionType] || 'all';
                
                // 触发筛选
                loadConnections();
            }
        }

        // 查看设备端口详情 - 跳转到连接列表并筛选对应设备
        function viewDevicePortDetails(deviceId) {
            // 切换到连接列表标签页
            const connectionListTab = document.getElementById('list-tab');
            if (connectionListTab) {
                const tab = new bootstrap.Tab(connectionListTab);
                tab.show();
            }
            
            // 设置设备筛选条件
            const deviceFilter = document.getElementById('deviceFilter');
            if (deviceFilter) {
                // 根据设备ID找到对应的设备名称
                const deviceOption = Array.from(deviceFilter.options).find(option => 
                    option.value === deviceId.toString()
                );
                if (deviceOption) {
                    deviceFilter.value = deviceId.toString();
                    // 触发筛选
                    loadConnections();
                } else {
                    // 如果没有找到对应的设备选项，先加载设备列表
                    loadDeviceOptions().then(() => {
                        deviceFilter.value = deviceId.toString();
                        loadConnections();
                    });
                }
            }
        }

        // 显示容量等级分布图表
        function showCapacityDistribution() {
            const section = document.getElementById('capacityDistributionSection');
            if (section) {
                section.style.display = 'block';
                // 确保数据已加载，如果没有则重新加载
                if (!portStatsManager.isDataLoaded) {
                    portStatsManager.loadPortStatistics();
                }
                // 滚动到该区域
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // 隐藏容量等级分布图表
        function hideCapacityDistribution() {
            const section = document.getElementById('capacityDistributionSection');
            if (section) {
                section.style.display = 'none';
            }
        }

        // 显示容量统计详情表格
        function showCapacityDetails() {
            const section = document.getElementById('capacityDetailsSection');
            if (section) {
                section.style.display = 'block';
                // 确保数据已加载，如果没有则重新加载
                if (!portStatsManager.isDataLoaded) {
                    portStatsManager.loadPortStatistics();
                }
                // 滚动到该区域
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // 隐藏容量统计详情表格
        function hideCapacityDetails() {
            const section = document.getElementById('capacityDetailsSection');
            if (section) {
                section.style.display = 'none';
            }
        }

        // 筛选连接数据
        function filterConnections() {
            loadConnections();
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 页面初始化完成
            console.log('连接管理页面加载完成');
        });

        // 新增：导出当前筛选结果为CSV
        async function exportConnections() {
            try {
                const typeFilter = document.getElementById('connectionTypeFilter').value;
                const deviceNameFilter = document.getElementById('deviceNameFilter').value.trim();
                
                // 分页逐页拉取，确保导出覆盖全部筛选结果
                const pageSize = 1000;
                let page = 1;
                let allRows = [];
                let totalPages = 1;
                
                // 先获取第一页，读取分页信息
                {
                    let url = `/api/connections?page=${page}&page_size=${pageSize}`;
                    const params = new URLSearchParams();
                    if (deviceNameFilter) params.append('device_name', deviceNameFilter);
                    if (params.toString()) url += `&${params.toString()}`;
                    const resp = await fetch(url);
                    if (!resp.ok) throw new Error(`获取连接数据失败: ${resp.status}`);
                    const result = await resp.json();
                    const data = result.data || [];
                    const pagination = result.pagination || { total_pages: 1 };
                    totalPages = pagination.total_pages || 1;
                    allRows = data;
                }
                
                // 拉取剩余页
                for (page = 2; page <= totalPages; page++) {
                    let url = `/api/connections?page=${page}&page_size=${pageSize}`;
                    const params = new URLSearchParams();
                    if (deviceNameFilter) params.append('device_name', deviceNameFilter);
                    if (params.toString()) url += `&${params.toString()}`;
                    const resp = await fetch(url);
                    if (!resp.ok) break; // 容错处理
                    const result = await resp.json();
                    const data = result.data || [];
                    allRows = allRows.concat(data);
                }
                
                // 根据类型在前端筛选，保持与列表一致
                if (typeFilter && typeFilter !== 'all') {
                    if (typeFilter === '空闲') {
                        allRows = allRows.filter(conn => isEmptyValue(conn.connection_type));
                    } else if (typeFilter === '已使用总量') {
                        allRows = allRows.filter(conn => !isEmptyValue(conn.connection_type));
                    } else {
                        // 交流/直流等
                        const allowedMap = {
                            '交流': ['交流','AC','ac'],
                            '直流': ['直流','DC','dc']
                        };
                        const allow = allowedMap[typeFilter] || [];
                        allRows = allRows.filter(conn => allow.includes(conn.connection_type));
                    }
                }
                
                // 生成CSV
                const headers = ['连接ID','A端设备','A端端口','A端额定电流','B端设备','B端端口','B端额定电流','连接类型','规格型号','备注'];
                const escape = v => '"' + String(v).replace(/"/g,'""') + '"';
                const rows = allRows.map(conn => [
                    sanitizeValue(conn.id),
                    sanitizeValue(conn.source_device_name),
                    sanitizeValue(conn.source_port),
                    sanitizeValue(conn.a_rated_current),
                    sanitizeValue(conn.target_device_name),
                    sanitizeValue(conn.target_port),
                    sanitizeValue(conn.b_rated_current),
                    (function(){
                        if (isEmptyValue(conn.connection_type)) return '空闲';
                        const m = { 'AC':'交流','ac':'交流','DC':'直流','dc':'直流','交流':'交流','直流':'直流' };
                        return sanitizeValue(m[conn.connection_type] || conn.connection_type);
                    })(),
                    sanitizeValue(conn.cable_model),
                    sanitizeValue(conn.remark)
                ].map(escape).join(','));
                
                const csvContent = '\uFEFF' + headers.join(',') + '\n' + rows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const ts = new Date();
                const tsStr = `${ts.getFullYear()}${String(ts.getMonth()+1).padStart(2,'0')}${String(ts.getDate()).padStart(2,'0')}_${String(ts.getHours()).padStart(2,'0')}${String(ts.getMinutes()).padStart(2,'0')}${String(ts.getSeconds()).padStart(2,'0')}`;
                a.href = url;
                a.download = `connections_export_${tsStr}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                const count = allRows.length;
                if (count === 0) {
                    alert('当前筛选结果为空，无可导出的数据');
                }
            } catch (error) {
                console.error('导出连接数据失败:', error);
                alert('导出失败: ' + (error && error.message ? error.message : '未知错误'));
            }
        }
    </script>
</body>
</html>