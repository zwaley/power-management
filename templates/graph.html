<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拓扑图 - DC Asset Manager</title>
    <!-- 引入Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入Font Awesome图标库 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- 引入vis.js网络图库的CSS -->
    <link href="https://visjs.github.io/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
    <style>
        /* 定义拓扑图容器的样式 */
        #mynetwork {
            width: 100%;
            height: 80vh; /* 高度为视口高度的80% */
            border: 1px solid lightgray;
            background-color: #f8f9fa;
        }
        
        /* 节点悬停提示框样式 */
        .node-tooltip {
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            max-width: 250px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            z-index: 9999;
        }
        
        .tooltip-header {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 6px;
            color: #ffd700;
            border-bottom: 1px solid #444;
            padding-bottom: 4px;
        }
        
        .tooltip-content {
            line-height: 1.4;
        }
        
        .tooltip-content div {
            margin-bottom: 3px;
        }
        
        .tooltip-content strong {
            color: #87ceeb;
        }
    </style>
</head>
<body>
    <!-- 页面导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">安吉电信动力设备管理系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/graph">拓扑图</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <h1>设备电力链路拓扑图</h1>
                <p>请从下方选择一个设备以查看其相关的电力链路。图中将展示该设备的直接上游和下游设备。</p>
                <div class="mb-3">
                    <label for="device-select" class="form-label"><strong>选择设备:</strong></label>
                    <!-- 设备选择下拉框，选项由后端模板引擎动态生成 -->
                    <select class="form-select" id="device-select">
                        <option selected disabled value="">请选择一个设备以生成拓扑图</option>
                        {% for device in devices %}
                        <option value="{{ device.id }}">{{ device.name }} (ID: {{ device.id }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- 拓扑图筛选控制面板 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filterPanel" aria-expanded="false" aria-controls="filterPanel">
                                <i class="fas fa-filter"></i> 筛选选项
                            </button>
                        </h5>
                    </div>
                    <div id="filterPanel" class="collapse">
                        <div class="card-body">
                            <div class="row">
                                <!-- 层级选择 -->
                                <div class="col-md-3 mb-3">
                                    <label for="level-select" class="form-label">显示层级:</label>
                                    <select class="form-select" id="level-select">
                                        <option value="1">1层 - 设备拓扑图 (直接连接)</option>
                                        <option value="2" selected>2层 - 设备拓扑图 (推荐)</option>
                                        <option value="3">3层 - 设备拓扑图</option>
                                        <option value="4">4层 - 端口拓扑图</option>
                                        <option value="5">5层 - 端口拓扑图 (全链路)</option>
                                    </select>
                                </div>
                                
                                <!-- 布局类型选择 -->
                                <div class="col-md-3 mb-3" id="layout-type-container" style="display: none;">
                                    <label for="layout-type-select" class="form-label">布局类型:</label>
                                    <select class="form-select" id="layout-type-select">
                                        <option value="hierarchicalUD">分层布局(上下)</option>
                                        <option value="hierarchicalLR">分层布局(左右)</option>
                                        <option value="force">力导向布局</option>
                                    </select>
                                </div>
                                
                                <!-- 站点筛选 -->
                                <div class="col-md-3 mb-3">
                                    <label for="station-select" class="form-label">站点筛选:</label>
                                    <select class="form-select" id="station-select">
                                        <option value="">全部站点</option>
                                    </select>
                                </div>
                                
                                <!-- 设备类型筛选 -->
                                <div class="col-md-3 mb-3">
                                    <label for="device-type-select" class="form-label">设备类型:</label>
                                    <select class="form-select" id="device-type-select">
                                        <option value="">全部类型</option>
                                    </select>
                                </div>
                                
                                <!-- 连接类型筛选 -->
                                <div class="col-md-3 mb-3">
                                    <label for="connection-type-select" class="form-label">连接类型:</label>
                                    <select class="form-select" id="connection-type-select">
                                        <option value="">全部连接</option>
                                        <option value="电缆">电缆连接</option>
                                        <option value="母线">母线连接</option>
                                    </select>
                                </div>
                                
                                <!-- 关键路径筛选 -->
                                <div class="col-md-3 mb-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="critical-only-check">
                                        <label class="form-check-label" for="critical-only-check">
                                            仅显示关键路径
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- 仅A端视图选项 -->
                                <div class="col-md-4 mb-3" id="only-selected-device-container" style="display: none;">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="only-selected-device-check">
                                        <label class="form-check-label" for="only-selected-device-check">
                                            仅显示选中设备的端口
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- 分组大小设置 -->
                                <div class="col-md-4 mb-3" id="group-size-container" style="display: none;">
                                    <label for="group-size-input" class="form-label">分组大小:</label>
                                    <input type="number" class="form-control" id="group-size-input" min="2" max="20" value="5">
                                </div>
                                
                                <!-- 批量汇聚/展开按钮 -->
                                <div class="mt-2" id="bus-group-actions" style="display: none;">
                                    <button class="btn btn-sm btn-outline-secondary me-2" id="collapse-all-btn">
                                        <i class="fas fa-compress-alt"></i> 汇聚所有总线
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" id="expand-all-btn">
                                        <i class="fas fa-expand-alt"></i> 展开所有总线
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 操作按钮 -->
                            <div class="row">
                                <div class="col-12">
                                    <button class="btn btn-primary me-2" id="apply-filters-btn">
                                        <i class="fas fa-search"></i> 应用筛选
                                    </button>
                                    <button class="btn btn-secondary me-2" id="reset-filters-btn">
                                        <i class="fas fa-undo"></i> 重置筛选
                                    </button>
                                    <button class="btn btn-info" id="fullscreen-btn">
                                        <i class="fas fa-expand"></i> 全屏显示
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <!-- vis.js拓扑图将在此div中渲染 -->
                <div id="mynetwork"></div>
            </div>
        </div>
        
        <!-- 端口拓扑图区域 -->
        <div class="row mt-4" id="port-topology-section" style="display: none;">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-sitemap"></i> 端口拓扑图
                            <button class="btn btn-sm btn-outline-secondary float-end" id="port-topology-fullscreen-btn">
                                <i class="fas fa-expand"></i> 全屏
                            </button>
                            <button class="btn btn-sm btn-outline-danger float-end me-2" id="close-port-topology-btn">
                                <i class="fas fa-times"></i> 关闭
                            </button>
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- 端口拓扑图控制面板 -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="port-layout-select" class="form-label">布局类型:</label>
                                <select class="form-select" id="port-layout-select">
                                    <option value="hierarchicalLR">左右分列布局</option>
                                    <option value="hierarchicalUD">上下分层布局</option>
                                    <option value="force">力导向布局</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="port-filter-select" class="form-label">端口筛选:</label>
                                <select class="form-select" id="port-filter-select">
                                    <option value="">全部端口</option>
                                    <option value="input">输入端口</option>
                                    <option value="output">输出端口</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="show-port-labels-check" checked>
                                    <label class="form-check-label" for="show-port-labels-check">
                                        显示端口标签
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary mt-4" id="refresh-port-topology-btn">
                                    <i class="fas fa-sync"></i> 刷新
                                </button>
                            </div>
                        </div>
                        
                        <!-- 端口拓扑图容器 -->
                        <div id="port-topology-container" style="height: 500px; border: 1px solid #ddd; position: relative;">
                            <div class="d-flex justify-content-center align-items-center h-100">
                                <div class="text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> 加载端口拓扑图...
                                </div>
                            </div>
                        </div>
                        
                        <!-- SVG容器（备用） -->
                        <svg id="port-topology-svg" style="display: none;"></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 引入D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- 引入vis.js网络图 -->
    <script type="text/javascript" src="https://visjs.github.io/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="/static/js/port_topology.js"></script>
    
    <script type="text/javascript">
        // 全局变量声明
        var network = null;
        var nodes = null;
        var edges = null;
        let topologyData = {};
        let currentDeviceId = null;
        let currentGraphData = null;
        let groupingIndex = null;
        let portTopologyData = null;
        let isPortTopologyFullscreen = false;
        let tooltip = null;
        
        // 全局函数：渲染拓扑图
        function renderTopology(data) {
            try {
                // 处理节点数据 - 直接赋值给全局变量
                nodes = new vis.DataSet(data.nodes.map(node => {
                    // 创建两行标签：第一行站点+机房，第二行设备名称（去掉下划线）
                    const stationName = node.station || '未知站点';
                    const deviceName = node.deviceName || node.label || '未知设备';
                    
                    // 格式化设备名称：在"机房"后换行，去掉下划线
                    function formatDeviceLabel(station, deviceName) {
                        // 去掉设备名称中的下划线
                        let cleanDeviceName = deviceName.replace(/_/g, '');
                        
                        // 查找"机房"的位置
                        const roomIndex = cleanDeviceName.indexOf('机房');
                        if (roomIndex !== -1) {
                            // 在"机房"后分割
                            const roomPart = cleanDeviceName.substring(0, roomIndex + 2); // 包含"机房"
                            const devicePart = cleanDeviceName.substring(roomIndex + 2);
                            
                            // 第一行：站点 + 机房部分；第二行：设备部分
                            const firstLine = `${station}${roomPart}`;
                            const secondLine = devicePart;
                            
                            // 使用换行符而非HTML换行，便于自由拖拽与样式统一
                            return `${firstLine}\n${secondLine}`;
                        } else {
                            // 如果没有找到"机房"，使用两行：站点\n设备名
                            return `${station}\n${cleanDeviceName}`;
                        }
                    }
                    
                    const twoLineLabel = formatDeviceLabel(stationName, deviceName);
                    
                    return {
                        id: node.id,
                        label: twoLineLabel,
                        color: node.color || '#97C2FC',
                        shape: 'box',  // 强制使用方形
                        font: { 
                            size: 12, 
                            color: '#000000'
                        },
                        // 保存原始数据用于提示框
                        deviceName: node.deviceName,
                        deviceType: node.deviceType,
                        station: node.station,
                        nodeType: node.nodeType,
                        portName: node.portName,
                        portCount: node.portCount,
                        direction: node.direction,
                        voltage: node.voltage,
                        current: node.current
                    };
                }));
                
                // 处理边数据：保留所有有效连接，包括空标签的边
                const rawEdges = Array.isArray(data.edges) ? data.edges : [];
                const filteredEdges = rawEdges
                    .filter(edge => {
                        // 必须有有效的起止节点
                        if (!edge || !edge.from || !edge.to) return false;
                        // 统一计算标签：优先使用现有label，其次 connection_type/cable_type/cable_model
                        const resolvedLabel = (edge.label || edge.connection_type || edge.cable_type || edge.cable_model || '').toString();
                        const labelTrimmed = resolvedLabel.trim().toLowerCase();
                        // 只过滤掉明确的'nan'值，允许空标签
                        const isValidLabel = labelTrimmed !== 'nan';
                        return isValidLabel;
                    })
                    .map(edge => {
                        const fallbackId = `${edge.from || ''}->${edge.to || ''}:${edge.connection_id || edge.label || edge.cable_model || ''}`;
                        const resolvedLabel = (edge.label || edge.connection_type || edge.cable_type || edge.cable_model || '').toString();
                        return {
                            id: edge.id || fallbackId,
                            from: edge.from,
                            to: edge.to,
                            label: resolvedLabel,
                            color: edge.color || '#848484',
                            width: edge.width || 2,
                            // 默认使用箭头到to端，确保方向一致
                            arrows: edge.arrows || 'to',
                            // 保存原始数据用于提示框
                            connection_type: edge.connection_type,
                            cable_model: edge.cable_model,
                            cable_type: edge.cable_type,
                            remark: edge.remark,
                            connection_id: edge.connection_id
                        };
                    });

                edges = new vis.DataSet(filteredEdges);
                
                // 配置vis.js选项
                const options = {
                    layout: {
                        hierarchical: {
                            enabled: true,
                            direction: 'UD',
                            sortMethod: 'directed',
                            levelSeparation: 200,
                            nodeSpacing: 250,
                            treeSpacing: 250,
                            blockShifting: true,
                            edgeMinimization: true,
                            parentCentralization: true
                        }
                    },
                    physics: {
                        enabled: false,
                        // 允许节点在所有方向自由移动
                        stabilization: false
                    },
                    nodes: {
                        shape: 'box',  // 改为方形
                        size: 30,
                        borderWidth: 2,
                        shadow: true,
                        font: {
                            size: 12,
                            color: '#000000'
                        },
                        margin: 12,
                        widthConstraint: {
                            minimum: 180,
                            maximum: 220
                        },
                        heightConstraint: {
                            minimum: 70
                        }
                    },
                    edges: {
                        shadow: true,
                        smooth: {
                            enabled: true,
                            type: 'cubicBezier',
                            roundness: 0.4
                        }
                    },
                    interaction: {
                        dragNodes: true,
                        dragView: true,
                        zoomView: true,
                        selectConnectedEdges: false
                    },
                    manipulation: {
                        enabled: false
                    }
                };
                
                // 创建网络图
                network = new vis.Network(mynetwork, { nodes, edges }, options);
                // 为了允许用户在任意方向自由拖拽节点：
                // 先使用分层布局生成初始位置，然后立即关闭分层约束以开放自由拖拽
                try {
                    network.setOptions({ layout: { hierarchical: { enabled: false } } });
                } catch (_) {}
                
                // 节点拖动事件处理 - 允许全方向自由拖动
                network.on('dragStart', function(event) {
                    // 拖动开始时禁用物理引擎，避免自动重排
                    if (event.nodes.length > 0) {
                        network.setOptions({
                            physics: { enabled: false }
                        });
                    }
                });
                
                network.on('dragging', function(event) {
                    // 拖动过程中保持物理引擎禁用状态
                    // 节点可以在所有方向自由移动
                });
                
                network.on('dragEnd', function(event) {
                    // 拖动结束后保持物理引擎禁用，防止节点自动重排
                    if (event.nodes.length > 0) {
                        network.setOptions({
                            physics: { enabled: false }
                        });
                    }
                });
                
                // 添加事件监听器
                network.on('hoverNode', function(event) {
                    showNodeTooltip(event.event, event.node, nodes);
                });
                
                network.on('blurNode', function(event) {
                    hideNodeTooltip();
                });
                
                network.on('hoverEdge', function(event) {
                    const edge = edges.get(event.edge);
                    if (edge) {
                        showEdgeTooltip(event.event, edge);
                    }
                });
                
                network.on('blurEdge', function(event) {
                    hideNodeTooltip();
                });
                
                // 双击节点事件
                network.on('doubleClick', function(event) {
                    if (event.nodes.length > 0) {
                        const nodeId = event.nodes[0];
                        const node = nodes.get(nodeId);
                        if (node) {
                            showNodeDetails(node);
                        }
                    }
                });
                
                // 修复Canvas尺寸问题 - 强制设置容器尺寸并重绘网络
                setTimeout(() => {
                    try {
                        const container = document.getElementById('mynetwork');
                        if (container) {
                            // 强制设置容器样式
                            container.style.width = '100%';
                            container.style.height = '80vh';
                            container.style.minHeight = '600px';
                            container.style.display = 'block';
                            container.style.visibility = 'visible';
                            
                            // 如果网络已创建，重新调整和重绘
                            if (network) {
                                network.redraw();
                                network.fit();
                            }
                        }
                    } catch (fixError) {
                        console.warn('Canvas尺寸修复失败:', fixError);
                    }
                }, 100);
                
            } catch (error) {
                console.error('渲染拓扑图时发生错误:', error);
                mynetwork.innerHTML = `<div class="alert alert-danger" role="alert">渲染拓扑图失败：${error.message}</div>`;
            }
        }
        
        // 全局辅助函数：创建提示框
        function createTooltip() {
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'node-tooltip';
                tooltip.style.position = 'absolute';
                tooltip.style.background = 'rgba(0, 0, 0, 0.8)';
                tooltip.style.color = 'white';
                tooltip.style.padding = '8px 12px';
                tooltip.style.borderRadius = '4px';
                tooltip.style.fontSize = '12px';
                tooltip.style.zIndex = '1000';
                tooltip.style.pointerEvents = 'none';
                tooltip.style.maxWidth = '300px';
                tooltip.style.display = 'none';
                document.body.appendChild(tooltip);
            }
            return tooltip;
        }
        
        // 全局辅助函数：显示节点提示框
        function showNodeTooltip(event, nodeId, nodes) {
            const tooltip = createTooltip();
            const node = nodes.get(nodeId);
            if (!node) return;
            
            let htmlContent = '';
            let infoCount = 0;
            
            // 根据节点类型显示不同信息
            if (node.nodeType === 'bus') {
                htmlContent = `
                    <div class="tooltip-header">总线节点</div>
                    <div class="tooltip-content">
                        <div><strong>设备:</strong> ${node.deviceName || '未知'}</div>
                        <div><strong>端口数量:</strong> ${node.portCount || 0}</div>
                        <div><strong>电流方向:</strong> ${node.direction || '未知'}</div>
                    </div>
                `;
            } else if (node.nodeType === 'port') {
                htmlContent = `
                    <div class="tooltip-header">端口节点</div>
                    <div class="tooltip-content">
                        <div><strong>设备:</strong> ${node.deviceName || '未知'}</div>
                        <div><strong>端口:</strong> ${node.portName || '未知'}</div>
                        <div><strong>电流方向:</strong> ${node.direction || '未知'}</div>
                        ${node.voltage ? `<div><strong>电压等级:</strong> ${node.voltage}</div>` : ''}
                        ${node.current ? `<div><strong>额定电流:</strong> ${node.current}</div>` : ''}
                    </div>
                `;
            } else {
                // 设备节点
                htmlContent = `
                    <div class="tooltip-header">设备节点</div>
                    <div class="tooltip-content">
                        <div><strong>设备名称:</strong> ${node.label || '未知'}</div>
                        <div><strong>设备类型:</strong> ${node.deviceType || '未知'}</div>
                        <div><strong>站点:</strong> ${node.station || '未知'}</div>
                    </div>
                `;
            }
            
            tooltip.innerHTML = htmlContent;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            tooltip.style.display = 'block';
        }
        
        // 全局辅助函数：隐藏节点提示框
        function hideNodeTooltip() {
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }
        
        // 全局辅助函数：显示边的提示框
        function showEdgeTooltip(event, edge) {
            const tooltip = createTooltip();
            let htmlParts = [];
            let infoCount = 0;
            
            if (edge.connection_type || edge.cable_model || edge.cable_type || edge.remark || edge.connection_id) {
                htmlParts.push('<div class="tooltip-header">连接信息</div>');
                htmlParts.push('<div class="tooltip-content">');
                if (edge.connection_type) htmlParts.push(`<div><strong>类型:</strong> ${edge.connection_type}</div>`);
                if (edge.cable_model)   { htmlParts.push(`<div><strong>线缆型号:</strong> ${edge.cable_model}</div>`); infoCount++; }
                if (edge.cable_type)    { htmlParts.push(`<div><strong>线缆类型:</strong> ${edge.cable_type}</div>`); infoCount++; }
                if (edge.remark)        { htmlParts.push(`<div><strong>备注:</strong> ${edge.remark}</div>`); infoCount++; }
                if (edge.connection_id) { htmlParts.push(`<div><strong>ID:</strong> ${edge.connection_id}</div>`); infoCount++; }
                htmlParts.push('</div>');
            } else {
                // 基本边信息
                const typeText = edge.connection_type || '连接';
                const labelTxt = edge.label;
                const fromText = `节点 ${edge.from}`;
                const toText = `节点 ${edge.to}`;
                
                htmlParts.push('<div class="tooltip-header">连接信息</div>');
                htmlParts.push('<div class="tooltip-content">');
                htmlParts.push(`<div><strong>类型:</strong> ${typeText}</div>`);
                if (labelTxt) htmlParts.push(`<div><strong>标签:</strong> ${labelTxt}</div>`);
                htmlParts.push(`<div><strong>来源:</strong> ${fromText}</div>`);
                htmlParts.push(`<div><strong>指向:</strong> ${toText}</div>`);
                htmlParts.push(`<div><strong>ID:</strong> ${edge.id}</div>`);
                htmlParts.push('</div>');
            }
            
            if (htmlParts.length === 0) {
                htmlParts.push(`<div><strong>ID:</strong> ${edge.id}</div>`);
            }
            
            tooltip.innerHTML = htmlParts.join('');
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            tooltip.style.display = 'block';
        }
        
        // 全局辅助函数：显示节点详情模态框
        function showNodeDetails(node) {
            // 创建模态框显示详细信息
            const modalHtml = `
                <div class="modal fade" id="nodeDetailsModal" tabindex="-1" aria-labelledby="nodeDetailsModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="nodeDetailsModalLabel">
                                    <i class="fas fa-info-circle me-2"></i>节点详细信息
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">基本信息</h6>
                                            </div>
                                            <div class="card-body">
                                                <table class="table table-sm">
                                                    <tr>
                                                        <td><strong>设备名称:</strong></td>
                                                        <td>${node.deviceName || node.label || '未知'}</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>设备类型:</strong></td>
                                                        <td>${node.deviceType || '未知'}</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>所属站点:</strong></td>
                                                        <td>${node.station || '未知'}</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>节点类型:</strong></td>
                                                        <td>${node.nodeType || '设备节点'}</td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">技术参数</h6>
                                            </div>
                                            <div class="card-body">
                                                <table class="table table-sm">
                                                    ${node.voltage ? `<tr><td><strong>电压等级:</strong></td><td>${node.voltage}</td></tr>` : ''}
                                                    ${node.current ? `<tr><td><strong>额定电流:</strong></td><td>${node.current}</td></tr>` : ''}
                                                    ${node.portCount ? `<tr><td><strong>端口数量:</strong></td><td>${node.portCount}</td></tr>` : ''}
                                                    ${node.direction ? `<tr><td><strong>电流方向:</strong></td><td>${node.direction}</td></tr>` : ''}
                                                    ${node.portName ? `<tr><td><strong>端口名称:</strong></td><td>${node.portName}</td></tr>` : ''}
                                                    ${!node.voltage && !node.current && !node.portCount && !node.direction && !node.portName ? 
                                                        '<tr><td colspan="2" class="text-muted">暂无技术参数信息</td></tr>' : ''}
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">操作选项</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-primary btn-sm" onclick="viewDeviceDetails('${node.id}')">
                                                        <i class="fas fa-eye me-1"></i>查看设备详情
                                                    </button>
                                                    <button type="button" class="btn btn-info btn-sm" onclick="showConnections('${node.id}')">
                                                        <i class="fas fa-network-wired me-1"></i>查看连接关系
                                                    </button>
                                                    <button type="button" class="btn btn-success btn-sm" onclick="generateSubTopology('${node.id}')">
                                                        <i class="fas fa-sitemap me-1"></i>生成子拓扑图
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('nodeDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新的模态框到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('nodeDetailsModal'));
            modal.show();
        }
        
        // 辅助函数：查看设备详情
        function viewDeviceDetails(nodeId) {
            // 这里可以跳转到设备详情页面或显示更详细的信息
            alert(`查看设备详情功能开发中... 设备ID: ${nodeId}`);
        }
        
        // 辅助函数：显示连接关系
        function showConnections(nodeId) {
            // 这里可以显示该节点的所有连接关系
            alert(`显示连接关系功能开发中... 节点ID: ${nodeId}`);
        }
        
        // 辅助函数：生成子拓扑图
        function generateSubTopology(nodeId) {
            // 设置当前选择的设备ID
            currentDeviceId = nodeId;
            deviceSelect.value = nodeId;
            
            // 检查当前是否在端口拓扑图模式
            const levelValue = parseInt(levelSelect.value);
            if (levelValue >= 4) {
                // 如果当前在端口拓扑图模式，直接加载端口拓扑（视为重新生成）
                loadPortTopology(true);
            } else {
                // 否则生成设备拓扑图
                generateTopology();
            }
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('nodeDetailsModal'));
            if (modal) {
                modal.hide();
            }
        }

        // 全局函数：生成拓扑图
        async function generateTopology() {
            const selectedDeviceId = deviceSelect.value;
            if (!selectedDeviceId) {
                alert('请先选择一个设备');
                return;
            }
            
            currentDeviceId = selectedDeviceId;
            
            // 显示加载状态
            mynetwork.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><strong class="ms-3">正在加载拓扑图...</strong></div>';
            
            try {
                // 构建API URL
                // 根据层级选择不同的API端点
                const levelValue = levelSelect.value;
                let apiUrl, params;
                
                if (levelValue === '1' || levelValue === '2' || levelValue === '3') {
                    // 1-3级使用设备级拓扑API
                    let apiLevel = 'device';
                    if (levelValue === '2') apiLevel = 'device';
                    if (levelValue === '3') apiLevel = 'port';
                    
                    params = new URLSearchParams({
                        device_id: selectedDeviceId,
                        level: apiLevel
                    });
                    
                    // 添加筛选参数
                    if (stationSelect.value) params.append('station', stationSelect.value);
                    if (deviceTypeSelect.value) params.append('device_type', deviceTypeSelect.value);
                    if (connectionTypeSelect.value) params.append('connection_type', connectionTypeSelect.value);
                    if (criticalOnlyCheck.checked) params.append('critical_only', 'true');
                    
                    apiUrl = `/api/power-chain/${selectedDeviceId}?${params}`;
                } else if (levelValue === '4' || levelValue === '5') {
                    // 4-5级使用端口拓扑API
                    params = new URLSearchParams({
                        mode: 'detailed',
                        level: levelValue  // 添加层级参数
                    });
                    
                    // 添加筛选参数
                    if (stationSelect.value) params.append('station', stationSelect.value);
                    if (deviceTypeSelect.value) params.append('device_type', deviceTypeSelect.value);
                    if (connectionTypeSelect.value) params.append('connection_type', connectionTypeSelect.value);
                    if (criticalOnlyCheck.checked) params.append('critical_only', 'true');
                    
                    apiUrl = `/api/port-topology/${selectedDeviceId}?${params}`;
                }
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.nodes && data.edges) {
                    // 缓存当前图数据
                    currentGraphData = data;
                    currentDeviceId = selectedDeviceId; // 设置当前设备ID
                    renderTopology(data);
                } else {
                    mynetwork.innerHTML = '<div class="alert alert-info" role="alert">当前筛选条件下无可显示的数据，请调整筛选条件后重试。</div>';
                }
            } catch (error) {
                console.error('生成拓扑图失败:', error);
                mynetwork.innerHTML = `<div class="alert alert-warning" role="alert">
                    生成拓扑图时发生错误，请稍后重试。<br>
                    <small class="text-muted">错误详情: ${error.message}</small>
                </div>`;
            }
        }
        
        // 全局DOM元素引用
        let deviceSelect, mynetwork, portTopologyContainer, portTopologySvg, portTopologySection;
        let levelSelect, layoutTypeSelect, layoutTypeContainer;
        let stationSelect, deviceTypeSelect, connectionTypeSelect;
        let criticalOnlyCheck, applyFiltersBtn, resetFiltersBtn;
        let fullscreenBtn, portFullscreenBtn;
        let onlySelectedDeviceContainer, onlySelectedDeviceCheck;
        let groupSizeContainer, groupSizeInput;
        let busGroupActions, collapseAllBtn, expandAllBtn;
        
        // 端口拓扑图相关元素
        let portLayoutTypeSelect, portFilterSelect, showPortLabelsCheck, refreshPortBtn;
        
        // 等待 DOM 内容加载完成后执行
        document.addEventListener('DOMContentLoaded', function () {
            // 初始化页面元素引用
            deviceSelect = document.getElementById('device-select');
            mynetwork = document.getElementById('mynetwork');
            portTopologyContainer = document.getElementById('port-topology-container');
            portTopologySvg = document.getElementById('port-topology-svg');
            portTopologySection = document.getElementById('port-topology-section');
            levelSelect = document.getElementById('level-select');
            layoutTypeSelect = document.getElementById('layout-type-select');
            layoutTypeContainer = document.getElementById('layout-type-container');
            stationSelect = document.getElementById('station-select');
            deviceTypeSelect = document.getElementById('device-type-select');
            connectionTypeSelect = document.getElementById('connection-type-select');
            criticalOnlyCheck = document.getElementById('critical-only-check');
            applyFiltersBtn = document.getElementById('apply-filters-btn');
            resetFiltersBtn = document.getElementById('reset-filters-btn');
            fullscreenBtn = document.getElementById('fullscreen-btn');
            portFullscreenBtn = document.getElementById('port-topology-fullscreen-btn');
            // 仅A端视图相关元素
            onlySelectedDeviceContainer = document.getElementById('only-selected-device-container');
            onlySelectedDeviceCheck = document.getElementById('only-selected-device-check');
            
            // 端口拓扑图相关元素
            portLayoutTypeSelect = document.getElementById('port-layout-select');
            portFilterSelect = document.getElementById('port-filter-select');
            showPortLabelsCheck = document.getElementById('show-port-labels-check');
            refreshPortBtn = document.getElementById('refresh-port-topology-btn');
            groupSizeContainer = document.getElementById('group-size-container');
            groupSizeInput = document.getElementById('group-size-input');
            // 新增：汇聚/展开按钮的引用
            busGroupActions = document.getElementById('bus-group-actions');
            collapseAllBtn = document.getElementById('collapse-all-btn');
            expandAllBtn = document.getElementById('expand-all-btn');
            
            // 实例化端口拓扑管理器（单实例）
            if (!window.portTopologyManager && typeof PortTopologyManager === 'function') {
                window.portTopologyManager = new PortTopologyManager();
            }
            
            // 创建悬停提示框
            function createTooltip() {
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.className = 'node-tooltip';
                    tooltip.style.position = 'absolute';
                    tooltip.style.background = 'rgba(0, 0, 0, 0.8)';
                    tooltip.style.color = 'white';
                    tooltip.style.padding = '8px 12px';
                    tooltip.style.borderRadius = '4px';
                    tooltip.style.fontSize = '12px';
                    tooltip.style.zIndex = '1000';
                    tooltip.style.pointerEvents = 'none';
                    tooltip.style.maxWidth = '300px';
                    tooltip.style.display = 'none';
                    document.body.appendChild(tooltip);
                }
                return tooltip;
            }
            
            // 删除DOMContentLoaded监听器内的重复函数定义
            
            // 显示节点提示框
            function showNodeTooltip(event, nodeId, nodes) {
                const tooltip = createTooltip();
                const node = nodes.get(nodeId);
                if (!node) return;
                
                let htmlContent = '';
                let infoCount = 0;
                
                // 根据节点类型显示不同信息
                if (node.nodeType === 'bus') {
                    htmlContent = `
                        <div class="tooltip-header">总线节点</div>
                        <div class="tooltip-content">
                            <div><strong>设备:</strong> ${node.deviceName || '未知'}</div>
                            <div><strong>端口数量:</strong> ${node.portCount || 0}</div>
                            <div><strong>电流方向:</strong> ${node.direction || '未知'}</div>
                        </div>
                    `;
                } else if (node.nodeType === 'port') {
                    htmlContent = `
                        <div class="tooltip-header">端口节点</div>
                        <div class="tooltip-content">
                            <div><strong>设备:</strong> ${node.deviceName || '未知'}</div>
                            <div><strong>端口:</strong> ${node.portName || '未知'}</div>
                            <div><strong>电流方向:</strong> ${node.direction || '未知'}</div>
                            ${node.voltage ? `<div><strong>电压等级:</strong> ${node.voltage}</div>` : ''}
                            ${node.current ? `<div><strong>额定电流:</strong> ${node.current}</div>` : ''}
                        </div>
                    `;
                } else {
                    // 设备节点
                    htmlContent = `
                        <div class="tooltip-header">设备节点</div>
                        <div class="tooltip-content">
                            <div><strong>设备名称:</strong> ${node.label || '未知'}</div>
                            <div><strong>设备类型:</strong> ${node.deviceType || '未知'}</div>
                            <div><strong>站点:</strong> ${node.station || '未知'}</div>
                        </div>
                    `;
                }
                
                tooltip.innerHTML = htmlContent;
                tooltip.style.left = (event.pageX + 10) + 'px';
                tooltip.style.top = (event.pageY - 10) + 'px';
                tooltip.style.display = 'block';
            }
            
            // 隐藏节点提示框
            function hideNodeTooltip() {
                if (tooltip) {
                    tooltip.style.display = 'none';
                }
            }
            
            // 加载设备选项
            async function loadDeviceOptions() {
                try {
                    const response = await fetch('/api/devices');
                    const data = await response.json();
                    
                    if (data.success) {
                        deviceSelect.innerHTML = '<option selected disabled value="">请选择一个设备以生成拓扑图</option>';
                        
                        // 按站点分组设备
                        const devicesByStation = {};
                        data.data.forEach(device => {
                            const station = device.station || '未分组';
                            if (!devicesByStation[station]) {
                                devicesByStation[station] = [];
                            }
                            devicesByStation[station].push(device);
                        });
                        
                        // 为每个站点创建选项组
                        Object.keys(devicesByStation).sort().forEach(station => {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = station;
                            
                            devicesByStation[station].forEach(device => {
                                const option = document.createElement('option');
                                option.value = device.id;
                                option.textContent = `${device.name} (ID: ${device.id})`;
                                optgroup.appendChild(option);
                            });
                            
                            deviceSelect.appendChild(optgroup);
                        });
                        
                        // 加载筛选选项
                        loadFilterOptions(data.data);
                    }
                } catch (error) {
                    console.error('加载设备选项失败:', error);
                    deviceSelect.innerHTML = '<option disabled>加载设备列表失败</option>';
                }
            }
            
            // 加载筛选选项
            function loadFilterOptions(devices) {
                // 提取唯一的站点
                const stations = [...new Set(devices.map(d => d.station).filter(s => s))];
                stationSelect.innerHTML = '<option value="">全部站点</option>';
                stations.sort().forEach(station => {
                    const option = document.createElement('option');
                    option.value = station;
                    option.textContent = station;
                    stationSelect.appendChild(option);
                });
                
                // 提取唯一的设备类型
                const deviceTypes = [...new Set(devices.map(d => d.device_type).filter(t => t))];
                deviceTypeSelect.innerHTML = '<option value="">全部类型</option>';
                deviceTypes.sort().forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    deviceTypeSelect.appendChild(option);
                });
            }
            
            // 生成拓扑图函数已移到全局作用域
            
            // renderTopology函数已移到全局作用域
            
            // 其他辅助函数已移到全局作用域
            
            // 重置筛选条件
            function resetFilters() {
                levelSelect.value = '2';
                stationSelect.value = '';
                deviceTypeSelect.value = '';
                connectionTypeSelect.value = '';
                criticalOnlyCheck.checked = false;
                
                // 如果有选中的设备，重新生成拓扑图
                if (currentDeviceId) {
                    generateTopology();
                }
            }
            
            // 全屏显示
            function toggleFullscreen() {
                if (!document.fullscreenElement) {
                    mynetwork.requestFullscreen().catch(err => {
                        console.error('无法进入全屏模式:', err);
                    });
                } else {
                    document.exitFullscreen();
                }
            }
            
            // 事件监听器
            deviceSelect.addEventListener('change', generateTopology);
            // 修复：根据层级选择决定调用设备/端口拓扑生成，避免两套渲染同时触发
            applyFiltersBtn.addEventListener('click', function() {
                const levelValue = parseInt(levelSelect.value);
                if (levelValue >= 4) {
                    // 端口层级：调用端口拓扑加载
                    try {
                        if (window.portTopologyManager) {
                            loadPortTopology(true);
                        } else {
                            // 未初始化管理器时，仅切换端口拓扑视图提示
                            showPortTopology();
                        }
                    } catch (err) {
                        console.error('应用筛选加载端口拓扑失败:', err);
                    }
                } else {
                    // 设备层级：生成设备拓扑
                    generateTopology();
                }
            });
            resetFiltersBtn.addEventListener('click', resetFilters);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            
            // 层级选择变化时的处理
            levelSelect.addEventListener('change', function() {
                // 根据层级显示/隐藏布局选项
                if (parseInt(this.value) >= 3) {
                    layoutTypeContainer.style.display = 'block';
                } else {
                    layoutTypeContainer.style.display = 'none';
                }
                
                // 根据层级切换拓扑图类型
                if (parseInt(this.value) >= 4) {
                    // 显示端口拓扑图
                    showPortTopology();
                } else {
                    // 显示设备拓扑图
                    showDeviceTopology();
                }
            });
            
            // 端口拓扑图相关事件监听
            if (refreshPortBtn) {
                // 刷新视为“重新生成”，清空并恢复默认布局
                refreshPortBtn.addEventListener('click', function() { loadPortTopology(true); });
            }
            if (portLayoutTypeSelect) {
                portLayoutTypeSelect.addEventListener('change', updatePortLayout);
            }
            if (showPortLabelsCheck) {
                showPortLabelsCheck.addEventListener('change', togglePortLabels);
            }
            // 端口拓扑全屏按钮（统一调用 PortTopologyManager.toggleFullscreen）
            if (portFullscreenBtn) {
                portFullscreenBtn.addEventListener('click', function () {
                    try {
                        if (window.portTopologyManager && typeof window.portTopologyManager.toggleFullscreen === 'function') {
                            window.portTopologyManager.toggleFullscreen();
                        } else {
                            console.warn('PortTopologyManager 未就绪，暂无法切换全屏');
                        }
                    } catch (err) {
                        console.error('切换端口拓扑全屏失败:', err);
                    }
                });
            }
            // 端口拓扑关闭按钮
            const closePortTopologyBtn = document.getElementById('close-port-topology-btn');
            if (closePortTopologyBtn) {
                closePortTopologyBtn.addEventListener('click', function () {
                    if (levelSelect) levelSelect.value = '2';
                    showDeviceTopology();
                });
            }
            
            // 显示端口拓扑图
            function showPortTopology() {
                if (mynetwork) mynetwork.style.display = 'none';
                if (portTopologyContainer) portTopologyContainer.style.display = 'block';
                if (portTopologySection) portTopologySection.style.display = 'block';
                
                // 检查是否已选择设备
                if (!currentDeviceId) {
                    // 显示提示信息
                    showPortTopologyHint();
                    return;
                }
                
                // 兜底：若未实例化则先实例化（单实例）
                if (!window.portTopologyManager && typeof PortTopologyManager === 'function') {
                    window.portTopologyManager = new PortTopologyManager();
                }
                
                // 初始化端口拓扑图（切换视图等同重新生成）
                if (window.portTopologyManager) {
                    loadPortTopology(true);
                }
            }
            
            // 显示端口拓扑图提示信息
            function showPortTopologyHint() {
                if (portTopologyContainer) {
                    portTopologyContainer.innerHTML = `
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-center p-4">
                            <div class="mb-4">
                                <i class="fas fa-info-circle fa-3x text-info"></i>
                            </div>
                            <h5 class="text-muted mb-3">端口拓扑图</h5>
                            <p class="text-muted mb-4">
                                端口拓扑图显示设备的详细端口连接信息。<br>
                                请先在设备拓扑图中双击选择一个设备，然后切换到4-5层级查看其端口拓扑。
                            </p>
                            <div class="alert alert-info" role="alert">
                                <strong>操作步骤：</strong><br>
                                1. 切换到1-3层级查看设备拓扑图<br>
                                2. 双击选择要查看的设备<br>
                                3. 再切换到4-5层级查看端口拓扑图
                            </div>
                        </div>
                    `;
                }
            }
            
            // 加载端口拓扑图数据
            async function loadPortTopology(resetPositions = false) {
                if (!currentDeviceId) {
                    alert('请先选择一个设备');
                    return;
                }
                
                try {
                    // 初始化端口拓扑管理器
                    if (window.portTopologyManager) {
                        window.portTopologyManager.initialize('port-topology-container');
                        // 使用管理器的遮罩层显示加载状态
                        if (window.portTopologyManager.showLoading) {
                            window.portTopologyManager.showLoading();
                        }
                        
                        // 构建端口拓扑图API URL - 使用正确的端口拓扑图端点
                        let apiUrl = `/api/port-topology/${currentDeviceId}`;
                        const params = new URLSearchParams();
                        
                        // 添加筛选参数
                        if (portFilterSelect && portFilterSelect.value) {
                            params.append('port_type', portFilterSelect.value);
                        }
                        
                        // 如果有参数，添加到URL
                        if (params.toString()) {
                            apiUrl += `?${params.toString()}`;
                        }
                        
                        // 获取端口拓扑数据
                        const response = await fetch(apiUrl);
                        const data = await response.json();
                        
                        if (data.nodes && data.edges) {
                            // 更新端口拓扑图数据
                            window.portTopologyManager.updateTopologyData(data, { resetPositions });
                            
                            // 在数据更新后，应用当前布局选择，确保刷新或筛选后布局保持一致
                            if (portLayoutTypeSelect && typeof updatePortLayout === 'function') {
                                // 跳过一次本地位置恢复，以确保默认布局
                                if (resetPositions && window.portTopologyManager) {
                                    window.portTopologyManager.skipApplySavedPositionsOnce = true;
                                }
                                updatePortLayout();
                            }
                            // 隐藏加载遮罩
                            if (window.portTopologyManager.hideLoading) {
                                window.portTopologyManager.hideLoading();
                            }
                        } else {
                            // 隐藏加载遮罩
                            if (window.portTopologyManager.hideLoading) {
                                window.portTopologyManager.hideLoading();
                            }
                            if (portTopologyContainer) {
                                portTopologyContainer.innerHTML = '<div class="alert alert-info" role="alert">当前设备无端口数据可显示。</div>';
                            }
                        }
                    }
                } catch (error) {
                    console.error('加载端口拓扑图失败:', error);
                    if (window.portTopologyManager && window.portTopologyManager.showError) {
                        window.portTopologyManager.showError(error.message || '加载端口拓扑图失败');
                    } else if (portTopologyContainer) {
                        portTopologyContainer.innerHTML = `<div class="alert alert-warning" role="alert">
                            加载端口拓扑图时发生错误，请稍后重试。<br>
                            <small class="text-muted">错误详情: ${error.message}</small>
                        </div>`;
                    }
                }
            }
            
            // 更新端口拓扑图布局
            function updatePortLayout() {
                if (window.portTopologyManager && portLayoutTypeSelect) {
                    const layoutType = portLayoutTypeSelect.value;
                    console.log('更新端口拓扑图布局:', layoutType);
                    
                    // 调用端口拓扑管理器的布局更新方法
                    if (window.portTopologyManager.updateLayout) {
                        window.portTopologyManager.updateLayout(layoutType);
                    } else {
                        // 如果没有updateLayout方法，重新加载拓扑图（保持默认布局）
                        loadPortTopology(true);
                    }
                }
            }
            
            // 切换端口标签显示
            function togglePortLabels() {
                if (window.portTopologyManager && showPortLabelsCheck) {
                    const showLabels = showPortLabelsCheck.checked;
                    // 这里可以切换端口标签的显示/隐藏
                    console.log('切换端口标签显示:', showLabels);
                }
            }
            
            // 初始化页面
            loadDeviceOptions();
        });
    </script>
</body>
</html>