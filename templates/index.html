<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安吉电信动力设备管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 95%;
            width: 95%;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
        }
        .card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }
        th, td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        /* 特定列的对齐方式和宽度优化 */
        th:nth-child(1), td:nth-child(1) { /* ID */
            text-align: center;
            width: 50px;
        }
        th:nth-child(2), td:nth-child(2) { /* 资产编号 */
            text-align: left;
            width: 120px;
        }
        th:nth-child(3), td:nth-child(3) { /* 设备名称 */
            text-align: left;
            width: 180px;
        }
        th:nth-child(4), td:nth-child(4) { /* 局站 */
            text-align: center;
            width: 80px;
        }
        th:nth-child(5), td:nth-child(5) { /* 设备类型 */
            text-align: center;
            width: 100px;
        }
        th:nth-child(6), td:nth-child(6) { /* 设备型号 */
            text-align: left;
            width: 150px;
        }
        th:nth-child(7), td:nth-child(7) { /* 所在位置 */
            text-align: center;
            width: 80px;
        }
        th:nth-child(8), td:nth-child(8) { /* 额定容量 */
            text-align: right;
            font-family: 'Courier New', monospace;
            width: 90px;
        }
        th:nth-child(9), td:nth-child(9) { /* 设备生产厂家 */
            text-align: left;
            width: 150px;
        }
        th:nth-child(10), td:nth-child(10) { /* 投产日期 */
            text-align: center;
            font-family: 'Courier New', monospace;
            width: 100px;
        }
        th:nth-child(11), td:nth-child(11) { /* 生命周期状态 */
            text-align: center;
            width: 120px;
        }
        th:nth-child(12), td:nth-child(12) { /* 备注 */
            text-align: left;
            width: 80px;
        }
        th:nth-child(13), td:nth-child(13) { /* 操作 */
            text-align: center;
            width: 200px;
            min-width: 200px;
        }
        
        /* 操作列按钮样式已使用Bootstrap组件替换 */
        .table thead th {
            background-color: #4a69bd !important;
            color: #ffffff !important;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
            white-space: nowrap;
            position: relative;
            border-color: #4a69bd !important;
        }
        /* 表头分隔线 */
        thead th:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 20%;
            height: 60%;
            width: 1px;
            background-color: rgba(255, 255, 255, 0.3);
        }
        /* 数字列的特殊样式 */
        td:nth-child(8) { /* 额定容量 */
            font-weight: 500;
        }
        td:nth-child(10) { /* 投产日期 */
            font-weight: 500;
        }
        tbody tr:nth-of-type(even) {
            background-color: #e9ecef;
            color: #333333;
        }
        tbody tr:hover {
            background-color: #007bff;
            color: #ffffff;
        }
        .action-link {
            display: inline-block;
            padding: 8px 12px;
            background-color: #3498db;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .action-link:hover {
            background-color: #2980b9;
        }
        /* 为错误信息添加醒目的样式 */
        .error-message {
            color: #721c24; /* 深红色文字 */
            background-color: #f8d7da; /* 淡粉色背景 */
            border: 1px solid #f5c6cb; /* 粉色边框 */
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            border-radius: .25rem;
        }
        /* 为成功信息添加醒目的样式 */
        .success-message {
            color: #155724; /* 深绿色文字 */
            background-color: #d4edda; /* 淡绿色背景 */
            border: 1px solid #c3e6cb; /* 绿色边框 */
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            border-radius: .25rem;
            position: relative; /* 为关闭按钮定位 */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* 生命周期状态样式 */
        .lifecycle-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            display: inline-block;
            min-width: 60px;
        }
        
        .lifecycle-normal {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .lifecycle-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .lifecycle-expired {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .lifecycle-unknown {
            background-color: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }
        
        /* 成功信息关闭按钮样式 */
        .success-message .close-btn {
            background: none;
            border: none;
            color: #155724;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
            opacity: 0.7;
        }
        
        .success-message .close-btn:hover {
            opacity: 1;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .form-grid input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        
        /* 密码输入框样式优化 */
        .password-input-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .password-input-container input[type="password"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #fff;
        }
        
        .password-input-container input[type="password"]:focus {
            outline: none;
            border-color: #4a69bd;
            box-shadow: 0 0 0 3px rgba(74, 105, 189, 0.1);
        }
        
        .password-input-container.input-focused {
            transform: translateY(-1px);
        }
        
        .password-input-container.input-has-value input[type="password"] {
            border-color: #28a745;
        }
        
        .password-input-container input[type="password"]::placeholder {
            color: #6c757d;
            font-style: italic;
        }
        
        /* 固定表头样式 */
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .table-responsive table {
            position: relative;
        }
        
        .table-responsive thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #4a69bd !important; /* 使用统一的蓝色背景 */
            border-bottom: 2px solid #dee2e6;
        }
        
        /* 确保表头固定样式优先级 */
        .table-responsive .table thead th {
            position: sticky !important;
            top: 0 !important;
            z-index: 10 !important;
            background-color: #4a69bd !important;
        }
        
        /* 表格样式 */
        .table {
            margin-bottom: 0;
            table-layout: fixed;
        }
        
        /* 表头样式 - 参考连接管理页面 */
        .table thead th {
            background-color: #4a69bd !important;
            color: #ffffff !important;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
            white-space: nowrap;
            position: relative;
            border-color: #4a69bd !important;
            padding: 12px 15px;
        }
        
        /* 表头分隔线 */
        thead th:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 20%;
            height: 60%;
            width: 1px;
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* 设备管理表格列宽优化 */
        th:nth-child(1), td:nth-child(1) { /* ID */
            text-align: center;
            width: 60px;
        }
        th:nth-child(2), td:nth-child(2) { /* 资产编号 */
            text-align: left;
            width: 120px;
        }
        th:nth-child(3), td:nth-child(3) { /* 设备名称 */
            text-align: left;
            width: 150px;
        }
        th:nth-child(4), td:nth-child(4) { /* 局站 */
            text-align: left;
            width: 120px;
        }
        th:nth-child(5), td:nth-child(5) { /* 设备类型 */
            text-align: left;
            width: 100px;
        }
        th:nth-child(6), td:nth-child(6) { /* 设备型号 */
            text-align: left;
            width: 120px;
        }
        th:nth-child(7), td:nth-child(7) { /* 所在位置 */
            text-align: left;
            width: 120px;
        }
        th:nth-child(8), td:nth-child(8) { /* 额定容量 */
            text-align: right;
            width: 100px;
        }
        th:nth-child(9), td:nth-child(9) { /* 设备生产厂家 */
            text-align: left;
            width: 130px;
        }
        th:nth-child(10), td:nth-child(10) { /* 投产日期 */
            text-align: center;
            width: 100px;
        }
        th:nth-child(11), td:nth-child(11) { /* 生命周期状态 */
            text-align: center;
            width: 120px;
        }
        th:nth-child(12), td:nth-child(12) { /* 备注 */
            text-align: left;
            width: 120px;
        }
        th:nth-child(13), td:nth-child(13) { /* 操作 */
            text-align: center;
            width: 180px;
            min-width: 180px;
        }
        
        .table td {
            vertical-align: middle;
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }
        
        tbody tr:nth-of-type(even) {
            background-color: #e9ecef;
            color: #333333;
        }
        tbody tr:hover {
            background-color: #007bff;
            color: #ffffff;
        }
        
        /* 页面导航按钮样式已使用Bootstrap组件替换 */
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-bolt"></i> 安吉电信动力设备管理系统
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="/">设备管理</a>
                <a class="nav-link" href="/connections">连接管理</a>
                <a class="nav-link" href="/analytics">统计分析</a>
                <a class="nav-link" href="/lifecycle-management">生命周期管理</a>
                <a class="nav-link" href="/topology">拓扑图</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="fas fa-server"></i> 设备管理</h2>
                <p class="text-muted">管理动力设备信息，包括设备导入、查询、编辑和导出功能</p>
            </div>
        </div>

        <!-- 文件上传表单 -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0 text-primary fw-bold"><i class="fas fa-upload me-2"></i> 上传资产 Excel 文件</h5>
            </div>
            <div class="card-body">
            
            <!-- 如果有上传错误，则显示错误信息 -->
            {% if upload_error %}
                <div class="error-message" role="alert">
                    <strong>上传失败:</strong> {{ upload_error }}
                </div>
            {% endif %}
            
            {% if upload_error %}
             <div class="error-message">
                 {{ upload_error }}
             </div>
             {% endif %}
             
             {% if success_message %}
             <div class="success-message" id="successMessage">
                 <span>{{ success_message }}</span>
                 <button class="close-btn" onclick="closeSuccessMessage()">&times;</button>
             </div>
             {% endif %}

                <form action="/upload" method="post" enctype="multipart/form-data">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="file" class="form-label fw-bold text-primary">选择文件</label>
                            <input type="file" name="file" accept=".xlsx, .xls" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label for="password" class="form-label fw-bold text-danger">管理员密码</label>
                            <input type="password" id="password" name="password" class="form-control" placeholder="请输入密码" required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100"><i class="fas fa-upload"></i> 上传文件</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 手动添加设备表单 -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0 text-success fw-bold"><i class="fas fa-plus me-2"></i> 手动添加设备</h5>
            </div>
            <div class="card-body">
                <form action="/devices" method="post">
                    <!-- 第一行：基本信息 -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-primary">资产编号 *</label>
                            <input type="text" name="asset_id" class="form-control" placeholder="输入资产编号" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-primary">设备名称 *</label>
                            <input type="text" name="name" class="form-control" placeholder="输入设备名称" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-primary">局站 *</label>
                            <input type="text" name="station" class="form-control" placeholder="输入局站名称" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-primary">设备类型 *</label>
                            <select name="device_type" class="form-select" required>
                                <option value="" disabled selected>请选择设备类型</option>
                                {% for type in device_types %}
                                <option value="{{ type }}">{{ type }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- 第二行：设备详情 -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-primary">设备型号</label>
                            <input type="text" name="model" class="form-control" placeholder="输入型号">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-primary">额定容量</label>
                            <input type="text" name="power_rating" class="form-control" placeholder="输入容量">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-primary">所在位置</label>
                            <input type="text" name="location" class="form-control" placeholder="输入位置信息">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-primary">生产厂家</label>
                            <input type="text" name="vendor" class="form-control" placeholder="输入厂家名称">
                        </div>
                    </div>
                    
                    <!-- 第三行：其他信息和操作 -->
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-primary">投产日期</label>
                            <input type="text" name="commission_date" class="form-control" placeholder="YYYY-MM-DD">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-primary">备注</label>
                            <input type="text" name="remark" class="form-control" placeholder="输入备注信息">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-danger">管理员密码 *</label>
                            <input type="password" id="manual-password" name="password" class="form-control" placeholder="输入密码" required>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-success w-100"><i class="fas fa-plus"></i> 添加设备</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 设备列表 -->
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list"></i> 设备列表</h5>
                <button class="btn btn-primary btn-sm" onclick="showExportDialog()">
                    <i class="fas fa-download"></i> 导出数据
                </button>
            </div>
            <div class="card-body">
                <!-- 筛选功能 -->
                <div class="mb-3 p-3 bg-light rounded border">
                    <h6 class="mb-3 text-secondary"><i class="fas fa-filter"></i> 筛选设备</h6>
                    <div class="row g-3">
                        <div class="col-md-6 col-lg-4">
                            <label for="stationFilter" class="form-label fw-bold">按局站筛选:</label>
                            <select id="stationFilter" class="form-select" onchange="filterDevices()">
                                <option value="">全部局站</option>
                                {% for station in stations %}
                                <option value="{{ station }}">{{ station }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <label for="nameFilter" class="form-label fw-bold">按设备名称筛选:</label>
                            <input type="text" id="nameFilter" class="form-control" placeholder="输入设备名称" onkeyup="filterDevices()">
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <label for="deviceTypeFilter" class="form-label fw-bold">按设备类型筛选:</label>
                            <select id="deviceTypeFilter" class="form-select" onchange="filterDevices()">
                                <option value="">全部类型</option>
                                {% for device_type in device_types %}
                                <option value="{{ device_type }}">{{ device_type }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <label for="vendorFilter" class="form-label fw-bold">按生产厂家筛选:</label>
                            <input type="text" id="vendorFilter" class="form-control" placeholder="输入厂家名称(支持模糊查询)" onkeyup="filterDevices()">
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <label for="lifecycleFilter" class="form-label fw-bold">生命周期状态:</label>
                            <select id="lifecycleFilter" class="form-select" onchange="filterDevices()">
                                <option value="">全部状态</option>
                                <option value="normal">正常设备</option>
                                <option value="warning">临近超限</option>
                                <option value="expired">已超期</option>
                                <option value="unknown">未配置规则</option>
                            </select>
                        </div>
                        <div class="col-md-6 col-lg-2">
                            <label class="form-label fw-bold text-transparent">操作:</label>
                            <button type="button" class="btn btn-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times"></i> 清除筛选
                            </button>
                        </div>
                        <div class="col-md-6 col-lg-2">
                            <label class="form-label fw-bold text-transparent">管理:</label>
                            <button type="button" class="btn btn-success w-100" onclick="goToLifecycleManagement()">
                                <i class="fas fa-clock"></i> 生命周期管理
                            </button>
                        </div>
                    </div>
            </div>
            
            <div class="table-responsive">
                <table id="deviceTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>资产编号</th>
                        <th>设备名称</th>
                        <th>局站</th>
                        <th>设备类型</th>
                        <th>设备型号</th>
                        <th>所在位置</th>
                        <th>额定容量</th>
                        <th>设备生产厂家</th>
                        <th>投产日期</th>
                        <th>生命周期状态</th>
                        <th>备注</th>
                        <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for device in devices %}
                <tr data-lifecycle-status="{{ device.lifecycle_status or 'unknown' }}">
                    <td>{{ device.id }}</td>
                    <td>{{ device.asset_id }}</td>
                    <td>{{ device.name }}</td>
                    <td>{{ device.station or 'N/A' }}</td>
                    <td>{{ device.device_type or 'N/A' }}</td>
                    <td>{{ device.model or 'N/A' }}</td>
                    <td>{{ device.location or 'N/A' }}</td>
                    <td>{{ device.power_rating or 'N/A' }}</td>
                    <td>{{ device.vendor or 'N/A' }}</td>
                    <td>{{ device.commission_date or 'N/A' }}</td>
                    <td>
                        <span class="lifecycle-badge lifecycle-{{ device.lifecycle_status or 'unknown' }}">
                            {{ device.lifecycle_status_text or '未知状态' }}
                        </span>
                    </td>
                    <td>{{ device.remark or 'N/A' }}</td>
                    <td>
                        <div class="d-flex gap-1 flex-wrap">
                            <a href="/graph/{{ device.id }}" target="_blank" class="btn btn-info btn-sm text-white">
                                <i class="fas fa-project-diagram"></i> 拓扑图
                            </a>
                            <button onclick="editDevice({{ device.id }})" class="btn btn-warning btn-sm text-dark">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button onclick="deleteDevice({{ device.id }})" class="btn btn-danger btn-sm text-white">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="13" class="text-center text-muted">暂无设备，请上传 Excel 文件或手动添加。</td>
                </tr>
                {% endfor %}
            </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>

    <!-- 页面导航按钮 -->
    <div class="position-fixed" style="bottom: 20px; right: 20px; z-index: 1000;">
        <div class="d-flex flex-column gap-2">
            <button class="btn btn-primary rounded-circle" onclick="scrollToTop()" title="回到顶部" style="width: 50px; height: 50px;">
                <i class="fas fa-arrow-up"></i>
            </button>
            <button class="btn btn-primary rounded-circle" onclick="scrollToBottom()" title="到达底部" style="width: 50px; height: 50px;">
                <i class="fas fa-arrow-down"></i>
            </button>
        </div>
    </div>

    <script>
        // 页面滚动功能
        function scrollToTop() {
            // 滚动到页面顶部
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
            
            // 同时滚动表格容器到顶部
            const tableContainer = document.querySelector('.table-responsive');
            if (tableContainer) {
                tableContainer.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToBottom() {
            // 先滚动到页面底部
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
            
            // 然后滚动表格容器到底部
            const tableContainer = document.querySelector('.table-responsive');
            if (tableContainer) {
                setTimeout(() => {
                    tableContainer.scrollTo({
                        top: tableContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 300); // 延迟300ms确保页面滚动完成
            }
        }
        
        // 创建密码输入对话框
        function showPasswordDialog(title, callback) {
            // 创建遮罩层
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;
            
            // 创建对话框
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                min-width: 300px;
                text-align: center;
            `;
            
            dialog.innerHTML = `
                <h3 style="margin-top: 0; color: #333;">${title}</h3>
                <p style="margin: 10px 0; color: #666; font-size: 14px; line-height: 1.4;">
                    为了保护系统安全，此操作需要管理员密码验证。<br>
                    请输入管理员密码以继续操作。
                </p>
                <input type="password" id="passwordInput" placeholder="请输入管理员密码" 
                       style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                <div style="margin-top: 15px;">
                    <button id="confirmBtn" style="background: #007bff; color: white; border: none; padding: 8px 16px; margin: 0 5px; border-radius: 4px; cursor: pointer;">确定</button>
                    <button id="cancelBtn" style="background: #6c757d; color: white; border: none; padding: 8px 16px; margin: 0 5px; border-radius: 4px; cursor: pointer;">取消</button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            const passwordInput = dialog.querySelector('#passwordInput');
            const confirmBtn = dialog.querySelector('#confirmBtn');
            const cancelBtn = dialog.querySelector('#cancelBtn');
            
            // 聚焦到密码输入框
            passwordInput.focus();
            
            // 处理确定按钮点击
            const handleConfirm = () => {
                const password = passwordInput.value;
                if (password.trim() === '') {
                    alert('密码不能为空');
                    passwordInput.focus();
                    return;
                }
                document.body.removeChild(overlay);
                callback(password);
            };
            
            // 处理取消按钮点击
            const handleCancel = () => {
                document.body.removeChild(overlay);
                callback(null);
            };
            
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            
            // 支持回车键确认
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleConfirm();
                }
            });
            
            // 支持ESC键取消
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    document.removeEventListener('keydown', escHandler);
                    handleCancel();
                }
            });
        }
        
        // 编辑设备函数
        function editDevice(deviceId) {
            showPasswordDialog('编辑设备', (password) => {
                if (password === null) return; // 用户取消
                
                // 跳转到编辑页面，传递设备ID和密码
                window.location.href = `/edit/${deviceId}?password=${encodeURIComponent(password)}`;
            });
        }
        
        // 删除设备函数
        function deleteDevice(deviceId) {
            if (!confirm('确定要删除这个设备吗？此操作不可撤销！')) {
                return;
            }
            
            showPasswordDialog('删除设备', (password) => {
                if (password === null) return; // 用户取消
                
                // 发送删除请求
                fetch(`/devices/${deviceId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                })
                .then(response => {
                    if (response.ok) {
                        alert('设备删除成功');
                        location.reload(); // 刷新页面
                    } else {
                        return response.json().then(data => {
                            alert(data.detail || '删除失败');
                        });
                    }
                })
                .catch(error => {
                    alert('删除失败：' + error.message);
                });
            });
        }
        
        // 保存筛选条件到localStorage
        function saveFilterConditions() {
            const filterConditions = {
                station: document.getElementById('stationFilter').value,
                name: document.getElementById('nameFilter').value,
                deviceType: document.getElementById('deviceTypeFilter').value,
                vendor: document.getElementById('vendorFilter').value,
                lifecycle: document.getElementById('lifecycleFilter').value
            };
            localStorage.setItem('deviceFilterConditions', JSON.stringify(filterConditions));
        }
        
        // 从localStorage恢复筛选条件
        function restoreFilterConditions() {
            try {
                const savedConditions = localStorage.getItem('deviceFilterConditions');
                if (savedConditions) {
                    const conditions = JSON.parse(savedConditions);
                    
                    // 恢复各个筛选条件
                    if (conditions.station) {
                        document.getElementById('stationFilter').value = conditions.station;
                    }
                    if (conditions.name) {
                        document.getElementById('nameFilter').value = conditions.name;
                    }
                    if (conditions.deviceType) {
                        document.getElementById('deviceTypeFilter').value = conditions.deviceType;
                    }
                    if (conditions.vendor) {
                        document.getElementById('vendorFilter').value = conditions.vendor;
                    }
                    if (conditions.lifecycle) {
                        document.getElementById('lifecycleFilter').value = conditions.lifecycle;
                    }
                    
                    // 应用恢复的筛选条件
                    filterDevices();
                }
            } catch (error) {
                console.error('恢复筛选条件失败:', error);
                // 如果恢复失败，清除损坏的数据
                localStorage.removeItem('deviceFilterConditions');
            }
        }

        // 设备筛选功能
        function filterDevices() {
            const stationFilter = document.getElementById('stationFilter').value.toLowerCase();
            const nameFilter = document.getElementById('nameFilter').value.toLowerCase();
            const deviceTypeFilter = document.getElementById('deviceTypeFilter').value.toLowerCase();
            const vendorFilter = document.getElementById('vendorFilter').value.toLowerCase();
            const lifecycleFilter = document.getElementById('lifecycleFilter').value;
            const table = document.getElementById('deviceTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            
            // 保存当前筛选条件
            saveFilterConditions();
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const stationCell = row.cells[3];     // 局站列（第4列，索引为3）
                const nameCell = row.cells[2];        // 设备名称列（第3列，索引为2）
                const deviceTypeCell = row.cells[4];  // 设备类型列（第5列，索引为4）
                const vendorCell = row.cells[8];      // 厂家列（第9列，索引为8）
                
                if (stationCell && nameCell && deviceTypeCell && vendorCell) {
                    const stationText = stationCell.textContent.toLowerCase();
                    const nameText = nameCell.textContent.toLowerCase();
                    const deviceTypeText = deviceTypeCell.textContent.toLowerCase();
                    const vendorText = vendorCell.textContent.toLowerCase();
                    const lifecycleStatus = row.getAttribute('data-lifecycle-status') || 'unknown';
                    
                    const stationMatch = stationFilter === '' || stationText.includes(stationFilter);
                    const nameMatch = nameFilter === '' || nameText.includes(nameFilter);
                    const deviceTypeMatch = deviceTypeFilter === '' || deviceTypeText.includes(deviceTypeFilter);
                    const vendorMatch = vendorFilter === '' || vendorText.includes(vendorFilter); // 支持模糊查询
                    const lifecycleMatch = lifecycleFilter === '' || lifecycleStatus === lifecycleFilter;
                    
                    if (stationMatch && nameMatch && deviceTypeMatch && vendorMatch && lifecycleMatch) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            }
        }
        
        // 清除筛选条件
        function clearFilters() {
            document.getElementById('stationFilter').value = '';
            document.getElementById('nameFilter').value = '';
            document.getElementById('deviceTypeFilter').value = '';
            document.getElementById('vendorFilter').value = '';
            document.getElementById('lifecycleFilter').value = '';
            
            // 清除localStorage中保存的筛选条件
            localStorage.removeItem('deviceFilterConditions');
            
            filterDevices();
        }
        
        // 跳转到生命周期管理页面
        function goToLifecycleManagement() {
            window.location.href = '/lifecycle-management';
        }
        
        // 关闭成功信息函数
        function closeSuccessMessage() {
            const successMessage = document.getElementById('successMessage');
            if (successMessage) {
                successMessage.style.display = 'none';
                // 清除URL中的success参数
                const url = new URL(window.location);
                url.searchParams.delete('success');
                window.history.replaceState({}, document.title, url.pathname + url.search);
            }
        }
        
        // 页面加载完成后，5秒后自动隐藏成功信息
        document.addEventListener('DOMContentLoaded', function() {
            const successMessage = document.getElementById('successMessage');
            if (successMessage) {
                // 5秒后自动隐藏
                setTimeout(function() {
                    closeSuccessMessage();
                }, 5000);
            }
            
            // 恢复筛选条件
            restoreFilterConditions();
        });
    </script>
    
    <!-- 导出确认对话框 -->
    <div id="exportDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 400px;">
            <h3 style="margin-top: 0; color: #495057; text-align: center;">导出设备数据</h3>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">导出范围：</label>
                <div style="margin-bottom: 10px;">
                    <input type="radio" id="exportAll" name="exportRange" value="all" checked>
                    <label for="exportAll" style="margin-left: 5px;">全部设备数据</label>
                </div>
                <div>
                    <input type="radio" id="exportFiltered" name="exportRange" value="filtered">
                    <label for="exportFiltered" style="margin-left: 5px;">当前筛选结果</label>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="exportPassword" style="display: block; margin-bottom: 8px; font-weight: bold;">管理员密码：</label>
                <input type="password" id="exportPassword" placeholder="请输入管理员密码" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box;">
            </div>
            
            <div style="text-align: center; margin-top: 25px;">
                <button onclick="confirmExport()" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">确认导出</button>
                <button onclick="closeExportDialog()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">取消</button>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', path='script.js') }}"></script>
</body>
</html>